@page "/"
@inject ContractDiscovery Discovery
@inject ScQueryService QueryService

<h4>Qubic Smart Contract Tester</h4>
<p class="text-muted">Browse and test all discovered smart contract functions.</p>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Connection</div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label small text-muted">Backend</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="rpcRadio"
                                   checked="@(QueryService.ActiveBackend == QueryBackend.Rpc)"
                                   @onchange="() => SetBackend(QueryBackend.Rpc)" />
                            <label class="form-check-label" for="rpcRadio">RPC</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="bobRadio"
                                   checked="@(QueryService.ActiveBackend == QueryBackend.Bob)"
                                   @onchange="() => SetBackend(QueryBackend.Bob)" />
                            <label class="form-check-label" for="bobRadio">Bob</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="directRadio"
                                   checked="@(QueryService.ActiveBackend == QueryBackend.DirectNetwork)"
                                   @onchange="() => SetBackend(QueryBackend.DirectNetwork)" />
                            <label class="form-check-label" for="directRadio">Direct Network</label>
                        </div>
                    </div>
                </div>
                @if (QueryService.ActiveBackend == QueryBackend.DirectNetwork)
                {
                    <div class="mb-2">
                        <label class="form-label small text-muted">Node Host</label>
                        <input class="form-control form-control-sm" @bind="QueryService.NodeHost" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small text-muted">Port</label>
                        <input type="number" class="form-control form-control-sm" style="width:120px" @bind="QueryService.NodePort" />
                    </div>
                }
                else
                {
                    <div class="mb-2">
                        <label class="form-label small text-muted">URL</label>
                        <input class="form-control form-control-sm" @bind="CurrentUrl" />
                    </div>
                }
                <button class="btn btn-sm btn-primary" @onclick="TestConnection" disabled="@_testing">
                    @(_testing ? "Testing..." : "Test Connection")
                </button>
                @if (_testResult != null)
                {
                    <span class="ms-2 badge @(_testSuccess ? "bg-success" : "bg-danger")">@_testResult</span>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Summary</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr><td class="text-muted">Contracts</td><td><strong>@Discovery.Contracts.Count</strong></td></tr>
                    <tr><td class="text-muted">Total Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count)</strong></td></tr>
                    <tr><td class="text-muted">Empty-Input Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count(f => f.IsEmptyInput))</strong></td></tr>
                    <tr><td class="text-muted">Parameterized Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count(f => !f.IsEmptyInput))</strong></td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<h5>Contracts</h5>
<table class="table table-sm table-hover">
    <thead>
        <tr>
            <th>Index</th>
            <th>Name</th>
            <th>Functions</th>
            <th>Empty-Input</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var contract in Discovery.Contracts)
        {
            <tr>
                <td>@contract.ContractIndex</td>
                <td><strong>@contract.Name</strong></td>
                <td>@contract.Functions.Count</td>
                <td>@contract.Functions.Count(f => f.IsEmptyInput)</td>
                <td><a href="/contract/@contract.ContractIndex" class="btn btn-sm btn-outline-primary">Open</a></td>
            </tr>
        }
    </tbody>
</table>

@code {
    private string CurrentUrl
    {
        get => QueryService.ActiveBackend == QueryBackend.Rpc ? QueryService.RpcUrl : QueryService.BobUrl;
        set
        {
            if (QueryService.ActiveBackend == QueryBackend.Rpc)
                QueryService.RpcUrl = value;
            else
                QueryService.BobUrl = value;
        }
    }

    private bool _testing;
    private bool _testSuccess;
    private string? _testResult;

    private void SetBackend(QueryBackend backend)
    {
        QueryService.ActiveBackend = backend;
        QueryService.ResetClients();
        _testResult = null;
    }

    private async Task TestConnection()
    {
        _testing = true;
        _testResult = null;
        try
        {
            // Try querying Qutil.GetFees (contract 4, inputType 1, empty input) as a connection test
            await QueryService.QueryAsync(4, 1, []);
            _testSuccess = true;
            _testResult = "Connected";
        }
        catch (Exception ex)
        {
            _testSuccess = false;
            _testResult = ex.Message.Length > 80 ? ex.Message[..80] + "..." : ex.Message;
        }
        finally
        {
            _testing = false;
        }
    }
}
