@inject QubicBackendService Backend
@inject QubicSettingsService Settings
@inject NavigationManager Nav
@implements IDisposable

<div class="sidebar bg-light border-end p-2" style="width:220px; min-width:220px; max-width:220px; flex-shrink:0; overflow-y:auto">
    <nav class="nav flex-column">
        <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </NavLink>

        @{ var favorites = GetFavorites(); }
        @if (favorites.Count > 0)
        {
            <div class="nav-section-header mt-2">
                <span class="nav-section-label"><i class="bi bi-star-fill me-1 text-warning"></i>FAVORITES</span>
            </div>
            <div class="nav-sub-links">
                @foreach (var path in favorites)
                {
                    if (PageRegistry.TryGetValue(path, out var info))
                    {
                        <div class="d-flex align-items-center nav-fav-row">
                            <NavLink class="nav-link flex-grow-1" href="@path">
                                <i class="bi @info.Icon me-2"></i>@info.Label
                            </NavLink>
                            <button class="btn btn-sm fav-btn active" @onclick="() => ToggleFav(path)" @onclick:preventDefault @onclick:stopPropagation title="Remove from favorites">
                                <i class="bi bi-star-fill"></i>
                            </button>
                        </div>
                    }
                }
            </div>
        }

        @* ── SEND & SIGN ── *@
        <div class="nav-section-header">
            <a class="nav-section-label" href="/signing">SEND & SIGN</a>
            <span class="nav-section-toggle" @onclick='() => Toggle("signing")'>
                <i class="bi bi-chevron-right chevron @(IsExpanded("signing") ? "expanded" : "")"></i>
            </span>
        </div>
        @if (IsExpanded("signing"))
        {
            <div class="nav-sub-links">
                @if (CanBroadcast)
                {
                    @NavItem("/tx/send", "bi-send", "Send QU")
                    @NavItem("/tx/send-many", "bi-send-plus", "Send to Many")
                    @NavItem("/tx/burn", "bi-fire", "Burn QU")
                    @NavItem("/tx/ipobid", "bi-cash-stack", "IPO Bid")
                    @NavItem("/tx/custom", "bi-code-square", "Custom Transaction")
                }
                @NavItem("/tx/offline", "bi-file-earmark-lock", "Offline Builder")
                @NavItem("/tools/sign-verify", "bi-shield-check", "Sign/Verify Message")
                @NavItem("/tx/history", "bi-list-ul", "Tx History")
            </div>
        }

        @* ── CONTRACTS ── *@
        <div class="nav-section-header">
            <a class="nav-section-label" href="/contracts">CONTRACTS</a>
            <span class="nav-section-toggle" @onclick='() => Toggle("contracts")'>
                <i class="bi bi-chevron-right chevron @(IsExpanded("contracts") ? "expanded" : "")"></i>
            </span>
        </div>
        @if (IsExpanded("contracts"))
        {
            <div class="nav-sub-links">
                @NavItem("/contracts/browser", "bi-box-seam", "Contract Browser")
                @if (CanBroadcast)
                {
                    <div class="nav-sub-header">DeFi</div>
                    @NavItem("/tx/qx", "bi-shop", "QX")
                    @NavItem("/tx/qswap", "bi-arrow-left-right", "QSwap")
                    @NavItem("/tx/qearn", "bi-piggy-bank", "QEarn")
                    @NavItem("/tx/qbond", "bi-coin", "QBond")
                    <div class="nav-sub-header">Utility</div>
                    @NavItem("/tx/qutil", "bi-bar-chart", "QUtil")
                    @NavItem("/tx/quottery", "bi-ticket-perforated", "Quottery")
                    <div class="nav-sub-header">Infrastructure</div>
                    @NavItem("/tx/msvault", "bi-people", "MSVault")
                    @NavItem("/tx/nostromo", "bi-rocket-takeoff", "Nostromo")
                    @NavItem("/tx/qvault", "bi-safe", "QVault")
                }
            </div>
        }

        @* ── EXPLORER ── *@
        <div class="nav-section-header">
            <a class="nav-section-label" href="/explorer">EXPLORER</a>
            <span class="nav-section-toggle" @onclick='() => Toggle("explorer")'>
                <i class="bi bi-chevron-right chevron @(IsExpanded("explorer") ? "expanded" : "")"></i>
            </span>
        </div>
        @if (IsExpanded("explorer"))
        {
            <div class="nav-sub-links">
                @NavItem("/wallet/balance", "bi-currency-exchange", "Balance Lookup")
                @NavItem("/wallet/assets", "bi-grid-3x3-gap", "Asset Portfolio")
                @NavItem("/tx/lookup", "bi-search", "Tx Lookup")
                @if (IsBob)
                {
                    @NavItem("/wallet/transfers", "bi-clock-history", "Transfer History")
                }
                @if (IsRpc)
                {
                    @NavItem("/explorer/tick", "bi-graph-up", "Tick Data")
                    @NavItem("/explorer/computors", "bi-hdd-network", "Computor List")
                    @NavItem("/explorer/ipos", "bi-rocket", "Active IPOs")
                    @NavItem("/explorer/checktx", "bi-check2-square", "Check Tx on Tick")
                }
                @if (IsDirectNetwork)
                {
                    @NavItem("/explorer/ipostatus", "bi-bar-chart-steps", "IPO Status")
                }
                @if (IsBob)
                {
                    @NavItem("/explorer/logs", "bi-file-text", "Log Viewer")
                }
            </div>
        }

        @* ── TOOLS ── *@
        <div class="nav-section-header">
            <a class="nav-section-label" href="/tools">TOOLS</a>
            <span class="nav-section-toggle" @onclick='() => Toggle("tools")'>
                <i class="bi bi-chevron-right chevron @(IsExpanded("tools") ? "expanded" : "")"></i>
            </span>
        </div>
        @if (IsExpanded("tools"))
        {
            <div class="nav-sub-links">
                @NavItem("/wallet/identity", "bi-person-badge", "Identity Generator")
                @if (CanBroadcast)
                {
                    @NavItem("/tx/import", "bi-broadcast", "Broadcast Tx")
                }
                @NavItem("/tools/crypto", "bi-key", "Crypto Toolkit")
                @NavItem("/tools/oracle", "bi-cloud-arrow-down", "Oracle Machine")
                @NavItem("/tools/bob-playground", "bi-terminal", "Bob Playground")
            </div>
        }

        @* ── COMPUTOR OPERATION ── *@
        @if (CanBroadcast || IsDirectNetwork)
        {
            <div class="nav-section-header">
                <a class="nav-section-label" href="/node">COMPUTOR OPERATION</a>
                <span class="nav-section-toggle" @onclick='() => Toggle("computor")'>
                    <i class="bi bi-chevron-right chevron @(IsExpanded("computor") ? "expanded" : "")"></i>
                </span>
            </div>
            @if (IsExpanded("computor"))
            {
                <div class="nav-sub-links">
                    @if (CanBroadcast)
                    {
                        @NavItem("/tx/governance", "bi-bank", "Governance")
                        @NavItem("/tx/ccf", "bi-currency-exchange", "CCF")
                    }
                    @if (IsDirectNetwork)
                    {
                        @NavItem("/node/peers", "bi-diagram-3", "Node Peers")
                        @NavItem("/node/management", "bi-sliders", "Node Management")
                    }
                </div>
            }
        }

        <hr class="my-2" />
        <NavLink class="nav-link" href="/settings">
            <i class="bi bi-gear me-2"></i>Settings
        </NavLink>
    </nav>
</div>

@code {
    private readonly HashSet<string> _expanded = [];

    private bool IsRpc => Backend.ActiveBackend == QueryBackend.Rpc;
    private bool IsBob => Backend.ActiveBackend == QueryBackend.Bob;
    private bool IsDirectNetwork => Backend.ActiveBackend == QueryBackend.DirectNetwork;
    private bool CanBroadcast => Backend.ActiveBackend is QueryBackend.Rpc or QueryBackend.DirectNetwork;

    private static readonly Dictionary<string, (string Label, string Icon)> PageRegistry = new()
    {
        ["/tx/send"] = ("Send QU", "bi-send"),
        ["/tx/send-many"] = ("Send to Many", "bi-send-plus"),
        ["/tx/burn"] = ("Burn QU", "bi-fire"),
        ["/tx/custom"] = ("Custom Transaction", "bi-code-square"),
        ["/tx/offline"] = ("Offline Builder", "bi-file-earmark-lock"),
        ["/tools/sign-verify"] = ("Sign/Verify Message", "bi-shield-check"),
        ["/tx/history"] = ("Tx History", "bi-list-ul"),
        ["/contracts/browser"] = ("Contract Browser", "bi-box-seam"),
        ["/tx/qx"] = ("QX", "bi-shop"),
        ["/tx/qswap"] = ("QSwap", "bi-arrow-left-right"),
        ["/tx/qearn"] = ("QEarn", "bi-piggy-bank"),
        ["/tx/qbond"] = ("QBond", "bi-coin"),
        ["/tx/qutil"] = ("QUtil", "bi-bar-chart"),
        ["/tx/quottery"] = ("Quottery", "bi-ticket-perforated"),
        ["/tx/msvault"] = ("MSVault", "bi-people"),
        ["/tx/nostromo"] = ("Nostromo", "bi-rocket-takeoff"),
        ["/tx/qvault"] = ("QVault", "bi-safe"),
        ["/tx/governance"] = ("Governance", "bi-bank"),
        ["/tx/ccf"] = ("CCF", "bi-currency-exchange"),
        ["/wallet/balance"] = ("Balance Lookup", "bi-currency-exchange"),
        ["/wallet/assets"] = ("Asset Portfolio", "bi-grid-3x3-gap"),
        ["/tx/lookup"] = ("Tx Lookup", "bi-search"),
        ["/wallet/transfers"] = ("Transfer History", "bi-clock-history"),
        ["/explorer/tick"] = ("Tick Data", "bi-graph-up"),
        ["/explorer/computors"] = ("Computor List", "bi-hdd-network"),
        ["/explorer/logs"] = ("Log Viewer", "bi-file-text"),
        ["/wallet/identity"] = ("Identity Generator", "bi-person-badge"),
        ["/tx/import"] = ("Broadcast Tx", "bi-broadcast"),
        ["/tools/crypto"] = ("Crypto Toolkit", "bi-key"),
        ["/tools/bob-playground"] = ("Bob Playground", "bi-terminal"),
        ["/tools/oracle"] = ("Oracle Machine", "bi-cloud-arrow-down"),
        ["/explorer/ipos"] = ("Active IPOs", "bi-rocket"),
        ["/explorer/ipostatus"] = ("IPO Status", "bi-bar-chart-steps"),
        ["/explorer/checktx"] = ("Check Tx on Tick", "bi-check2-square"),
        ["/tx/ipobid"] = ("IPO Bid", "bi-cash-stack"),
        ["/node/peers"] = ("Node Peers", "bi-diagram-3"),
        ["/node/management"] = ("Node Management", "bi-sliders"),
    };

    private static readonly Dictionary<string, string[]> SectionRoutes = new()
    {
        ["signing"] = ["/signing", "/tx/send", "/tx/send-many", "/tx/burn", "/tx/ipobid", "/tx/custom", "/tx/offline", "/tools/sign-verify", "/tx/history"],
        ["contracts"] = ["/contracts", "/contracts/", "/tx/qx", "/tx/qswap", "/tx/qearn", "/tx/qbond", "/tx/qutil", "/tx/quottery", "/tx/msvault", "/tx/nostromo", "/tx/qvault"],
        ["explorer"] = ["/explorer", "/explorer/", "/wallet/balance", "/wallet/assets", "/tx/lookup", "/wallet/transfers", "/explorer/tick", "/explorer/computors", "/explorer/ipos", "/explorer/ipostatus", "/explorer/checktx", "/explorer/logs"],
        ["tools"] = ["/tools", "/tools/", "/wallet/identity", "/tx/import", "/tools/crypto", "/tools/oracle", "/tools/bob-playground"],
        ["computor"] = ["/node", "/node/", "/tx/governance", "/tx/ccf", "/node/peers", "/node/management"],
    };

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
        AutoExpand(Nav.Uri);
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        AutoExpand(e.Location);
        InvokeAsync(StateHasChanged);
    }

    private void AutoExpand(string absoluteUri)
    {
        var path = new Uri(absoluteUri).AbsolutePath;
        foreach (var (section, routes) in SectionRoutes)
        {
            if (routes.Any(r => r.EndsWith('/') ? path.StartsWith(r, StringComparison.OrdinalIgnoreCase) : path.Equals(r, StringComparison.OrdinalIgnoreCase)))
            {
                _expanded.Add(section);
                break;
            }
        }
    }

    private bool IsExpanded(string section) => _expanded.Contains(section);

    private void Toggle(string section)
    {
        if (!_expanded.Remove(section))
            _expanded.Add(section);
    }

    private List<string> GetFavorites() => Settings.GetCustom<List<string>>("Favorites") ?? [];

    private bool IsFavorite(string path) => GetFavorites().Contains(path);

    private void ToggleFav(string path)
    {
        var favs = GetFavorites();
        if (!favs.Remove(path))
            favs.Add(path);
        Settings.SetCustom("Favorites", favs);
    }

    private RenderFragment NavItem(string href, string icon, string label) => __builder =>
    {
        <div class="d-flex align-items-center nav-fav-row">
            <NavLink class="nav-link flex-grow-1" href="@href">
                <i class="bi @icon me-2"></i>@label
            </NavLink>
            <button class="btn btn-sm fav-btn @(IsFavorite(href) ? "active" : "")"
                    @onclick="() => ToggleFav(href)" @onclick:preventDefault @onclick:stopPropagation
                    title="@(IsFavorite(href) ? "Remove from favorites" : "Add to favorites")">
                <i class="bi @(IsFavorite(href) ? "bi-star-fill" : "bi-star")"></i>
            </button>
        </div>
    };

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}
