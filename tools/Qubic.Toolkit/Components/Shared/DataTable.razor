@typeparam TItem

@* Column definitions register via CascadingValue but produce no visible output *@
<CascadingValue Value="this" IsFixed="true">
    @ChildContent
</CascadingValue>

@if (_columns.Count > 0)
{
    <table class="@TableClass">
        <thead>
            <tr>
                @if (ShowRowNumbers)
                {
                    <th style="width:40px">#</th>
                }
                @foreach (var col in _columns)
                {
                    <th class="@col.Class @(col.IsSortable ? "sortable-header" : "")"
                        style="@(col.Width != null ? $"width:{col.Width}" : "")"
                        @onclick="() => OnHeaderClick(col)">
                        @col.Title
                        @if (col.IsSortable && _sortColumn == col)
                        {
                            <i class="bi @(_sortAscending ? "bi-sort-up" : "bi-sort-down") ms-1"></i>
                        }
                    </th>
                }
            </tr>
            @if (_columns.Any(c => c.Filterable))
            {
                <tr class="table-filter-row">
                    @if (ShowRowNumbers)
                    {
                        <th></th>
                    }
                    @foreach (var col in _columns)
                    {
                        <th class="p-1">
                            @if (col.Filterable)
                            {
                                var localCol = col;
                                <input type="text" class="form-control form-control-sm py-0"
                                       placeholder="Filter..."
                                       value="@localCol.FilterValue"
                                       @oninput="e => SetFilter(localCol, e.Value?.ToString())" />
                            }
                        </th>
                    }
                </tr>
            }
        </thead>
        <tbody>
            @{
                var items = GetProcessedItems();
                var any = false;
                var rowNum = 0;
            }
            @if (items != null)
            {
                @foreach (var item in items)
                {
                    any = true;
                    rowNum++;
                    <tr @onclick="() => OnRowClick.InvokeAsync(item)"
                        class="@(RowClass?.Invoke(item))"
                        style="@(OnRowClick.HasDelegate ? "cursor:pointer" : "")">
                        @if (ShowRowNumbers)
                        {
                            <td>@rowNum</td>
                        }
                        @foreach (var col in _columns)
                        {
                            <td class="@col.Class">
                                @if (col.ChildContent != null)
                                {
                                    @col.ChildContent(item)
                                }
                                else if (col.Field != null)
                                {
                                    var val = col.Field(item);
                                    if (val is IFormattable fmt && col.Format != null)
                                    {
                                        @fmt.ToString(col.Format, null)
                                    }
                                    else
                                    {
                                        @(val?.ToString())
                                    }
                                }
                            </td>
                        }
                    </tr>
                }
            }
            @if (!any && Items != null)
            {
                <tr>
                    <td colspan="@(_columns.Count + (ShowRowNumbers ? 1 : 0))" class="text-muted text-center py-3">
                        @(EmptyMessage ?? "No data.")
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private readonly List<DataColumn<TItem>> _columns = [];
    private DataColumn<TItem>? _sortColumn;
    private bool _sortAscending = true;

    /// <summary>Data items to display.</summary>
    [Parameter] public IEnumerable<TItem>? Items { get; set; }

    /// <summary>Column definitions (DataColumn children).</summary>
    [Parameter] public RenderFragment? ChildContent { get; set; }

    /// <summary>CSS class for the table element.</summary>
    [Parameter] public string TableClass { get; set; } = "table table-sm table-hover mb-0";

    /// <summary>Whether to show row numbers.</summary>
    [Parameter] public bool ShowRowNumbers { get; set; }

    /// <summary>Row click handler.</summary>
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }

    /// <summary>Function returning CSS class for a row.</summary>
    [Parameter] public Func<TItem, string?>? RowClass { get; set; }

    /// <summary>Message when Items is non-null but empty.</summary>
    [Parameter] public string? EmptyMessage { get; set; }

    internal void AddColumn(DataColumn<TItem> column)
    {
        if (!_columns.Contains(column))
        {
            _columns.Add(column);
            if (column.DefaultSort)
            {
                _sortColumn = column;
                _sortAscending = !column.DefaultDescending;
            }
        }
        StateHasChanged();
    }

    private void OnHeaderClick(DataColumn<TItem> column)
    {
        if (!column.IsSortable) return;

        if (_sortColumn == column)
        {
            if (_sortAscending)
                _sortAscending = false;
            else
            {
                // Third click: clear sort
                _sortColumn = null;
                _sortAscending = true;
            }
        }
        else
        {
            _sortColumn = column;
            _sortAscending = true;
        }
    }

    private void SetFilter(DataColumn<TItem> col, string? value)
    {
        col.FilterValue = value ?? "";
    }

    private IEnumerable<TItem>? GetProcessedItems()
    {
        if (Items == null) return null;

        IEnumerable<TItem> result = Items;

        // Apply filters
        foreach (var col in _columns)
        {
            if (!col.Filterable || col.Field == null || string.IsNullOrWhiteSpace(col.FilterValue))
                continue;
            var filterText = col.FilterValue.Trim();
            var field = col.Field;
            result = result.Where(item =>
                field(item)?.ToString()?.Contains(filterText, StringComparison.OrdinalIgnoreCase) == true);
        }

        // Apply sort
        if (_sortColumn?.Field != null)
        {
            var field = _sortColumn.Field;
            result = _sortAscending
                ? result.OrderBy(item => field(item), NullSafeComparer.Instance)
                : result.OrderByDescending(item => field(item), NullSafeComparer.Instance);
        }

        return result;
    }

    /// <summary>Comparer that handles nulls, numeric types, and numeric strings.</summary>
    private sealed class NullSafeComparer : IComparer<object?>
    {
        public static readonly NullSafeComparer Instance = new();

        public int Compare(object? x, object? y)
        {
            if (x == null && y == null) return 0;
            if (x == null) return 1;
            if (y == null) return -1;

            // Both numeric — compare as double to handle cross-type (int vs uint vs long)
            if (IsNumeric(x) && IsNumeric(y))
                return Convert.ToDouble(x).CompareTo(Convert.ToDouble(y));

            // Both strings — try numeric parse before falling back to string compare
            if (x is string sx && y is string sy)
            {
                if (double.TryParse(sx, System.Globalization.NumberStyles.Any,
                        System.Globalization.CultureInfo.InvariantCulture, out var dx)
                    && double.TryParse(sy, System.Globalization.NumberStyles.Any,
                        System.Globalization.CultureInfo.InvariantCulture, out var dy))
                    return dx.CompareTo(dy);
                return string.Compare(sx, sy, StringComparison.OrdinalIgnoreCase);
            }

            if (x is IComparable cx && x.GetType() == y.GetType())
                return cx.CompareTo(y);

            return string.Compare(x.ToString(), y.ToString(), StringComparison.OrdinalIgnoreCase);
        }

        private static bool IsNumeric(object value) =>
            value is byte or sbyte or short or ushort or int or uint or long or ulong
                or float or double or decimal;
    }
}
