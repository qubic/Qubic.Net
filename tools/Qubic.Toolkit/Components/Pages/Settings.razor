@page "/settings"
@inject QubicSettingsService Cfg
@inject QubicBackendService Backend
@inject LabelService Labels
@inject QubicStaticService StaticData

<h4>Settings</h4>
<p class="text-muted">Configure Qubic.Net Toolkit behavior.</p>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(_tab == 0 ? "active" : "")" @onclick="() => _tab = 0">Connection</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(_tab == 1 ? "active" : "")" @onclick="() => _tab = 1">Transactions</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(_tab == 2 ? "active" : "")" @onclick="() => _tab = 2">Extended Services</button>
    </li>
</ul>

@if (_tab == 0)
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Backend</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Default Backend</label>
                        <select class="form-select" value="@Backend.ActiveBackend" @onchange="OnBackendChanged">
                            <option value="@QueryBackend.Rpc">RPC</option>
                            <option value="@QueryBackend.Bob">Bob (JSON-RPC)</option>
                            <option value="@QueryBackend.DirectNetwork">Direct Network</option>
                        </select>
                        <div class="form-text">
                            RPC supports most features. Bob provides transfer history and log viewer.
                            Direct Network connects to a node for IPO status, peer list, and node management.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Endpoints</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">RPC</label>
                        <div class="input-group">
                            <select class="form-select" style="max-width:100px"
                                    value="@Backend.RpcScheme" @onchange="OnRpcSchemeChanged">
                                <option value="https">https</option>
                                <option value="http">http</option>
                            </select>
                            <input type="text" class="form-control" placeholder="Host"
                                   value="@Backend.RpcHost" @onchange="OnRpcHostChanged" />
                            <input type="number" class="form-control" style="max-width:100px"
                                   placeholder="Port" min="1" max="65535"
                                   value="@Backend.RpcPort" @onchange="OnRpcPortChanged" />
                        </div>
                        <div class="form-text">Current: <code>@Backend.RpcUrl</code></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bob</label>
                        <div class="input-group">
                            <select class="form-select" style="max-width:100px"
                                    value="@Backend.BobScheme" @onchange="OnBobSchemeChanged">
                                <option value="https">https</option>
                                <option value="http">http</option>
                            </select>
                            <input type="text" class="form-control" placeholder="Host"
                                   value="@Backend.BobHost" @onchange="OnBobHostChanged" />
                            <input type="number" class="form-control" style="max-width:100px"
                                   placeholder="Port" min="1" max="65535"
                                   value="@Backend.BobPort" @onchange="OnBobPortChanged" />
                        </div>
                        <div class="form-text">Current: <code>@Backend.BobUrl</code></div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label">Direct Network</label>
                        <div class="input-group">
                            <span class="input-group-text" style="min-width:100px;justify-content:center">TCP</span>
                            <input type="text" class="form-control" placeholder="Host"
                                   value="@Backend.NodeHost" @onchange="OnNodeHostChanged" />
                            <input type="number" class="form-control" style="max-width:100px"
                                   placeholder="Port" min="1" max="65535"
                                   value="@Backend.NodePort" @onchange="OnNodePortChanged" />
                        </div>
                        <div class="form-text">Current: <code>tcp://@(Backend.NodeHost):@(Backend.NodePort)</code></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Peer Auto-Discovery</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Tick Threshold</label>
                        <input type="number" class="form-control" min="1" max="100"
                               value="@PeerTickThreshold"
                               @onchange="OnPeerTickThresholdChanged" />
                        <div class="form-text">
                            Switch to a different node if the current one is behind by more than this many ticks. Default: 10.
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label">Interval (minutes)</label>
                        <input type="number" class="form-control" min="0" max="1440"
                               value="@AutoDiscoverInterval"
                               @onchange="OnAutoDiscoverIntervalChanged" />
                        <div class="form-text">
                            Automatically discover and switch to the most recent peer at this interval.
                            Set to 0 to disable. Only active when using DirectNetwork backend.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (_tab == 1)
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Transaction Settings</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Auto-Tick Offset</label>
                        <input type="number" class="form-control" min="1" max="100"
                               value="@Cfg.TickOffset"
                               @onchange="e => Cfg.TickOffset = int.TryParse(e.Value?.ToString(), out var v) ? v : 5" />
                        <div class="form-text">
                            Number of ticks added to the current tick when using auto-tick.
                            Higher values give more time for the transaction to be processed but delay execution.
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoResend"
                                   checked="@Cfg.AutoResend"
                                   @onchange="e => Cfg.AutoResend = (bool)(e.Value ?? false)" />
                            <label class="form-check-label" for="autoResend">
                                Auto-Resend Failed Transactions
                            </label>
                        </div>
                        <div class="form-text">
                            When enabled, transactions whose target tick has passed without confirmation
                            will be automatically re-signed with a fresh tick and rebroadcast.
                            Requires an active seed.
                        </div>
                    </div>

                    @if (Cfg.AutoResend)
                    {
                        <div class="mb-0">
                            <label class="form-label">Max Resend Attempts</label>
                            <input type="number" class="form-control" min="1" max="20"
                                   value="@Cfg.AutoResendMaxRetries"
                                   @onchange="e => Cfg.AutoResendMaxRetries = int.TryParse(e.Value?.ToString(), out var v) ? v : 3" />
                            <div class="form-text">
                                Maximum number of times a transaction will be automatically resent before giving up.
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (_tab == 2)
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Address Labels</div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="remoteLabels"
                                   checked="@Cfg.RemoteLabelsEnabled"
                                   @onchange="OnRemoteLabelsToggled" />
                            <label class="form-check-label" for="remoteLabels">
                                Load labels from remote registry
                            </label>
                        </div>
                        <div class="form-text">
                            Fetches known address labels (exchanges, contracts, tokens) from
                            <code>static.qubic.org</code> on startup. Labels are shown next to addresses throughout the app.
                        </div>
                    </div>

                    @if (Cfg.RemoteLabelsEnabled)
                    {
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <button class="btn btn-outline-primary btn-sm" @onclick="RefreshLabels" disabled="@StaticData.IsLoading">
                                <i class="bi bi-arrow-clockwise me-1"></i>@(StaticData.IsLoading ? "Loading..." : "Refresh Labels")
                            </button>
                            @if (StaticData.LastFetched != null)
                            {
                                <span class="text-muted small">
                                    @Labels.RemoteLabelCount labels loaded at @StaticData.LastFetched.Value.ToString("HH:mm:ss")
                                </span>
                            }
                        </div>

                        @if (StaticData.LastError != null)
                        {
                            <div class="alert alert-danger small py-1 mb-0">@StaticData.LastError</div>
                        }
                    }
                </div>
            </div>
            <p class="text-muted small">
                Extended services fetch data from external servers. You can enable or disable each service individually.
            </p>
        </div>
    </div>
}

@code {
    private int _tab;

    private int PeerTickThreshold => Cfg.GetCustom<int>("PeerTickThreshold") is > 0 and var v ? v : 10;
    private int AutoDiscoverInterval => Cfg.GetCustom<int>("AutoDiscoverIntervalMinutes");

    private void OnPeerTickThresholdChanged(ChangeEventArgs e)
    {
        Cfg.SetCustom("PeerTickThreshold", int.TryParse(e.Value?.ToString(), out var v) ? v : 10);
    }

    private void OnAutoDiscoverIntervalChanged(ChangeEventArgs e)
    {
        Cfg.SetCustom("AutoDiscoverIntervalMinutes", int.TryParse(e.Value?.ToString(), out var v) ? v : 0);
    }

    private void OnBackendChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<QueryBackend>(e.Value?.ToString(), out var b))
        {
            Backend.ActiveBackend = b;
            Backend.ApplySettings();
        }
    }

    private void OnRpcSchemeChanged(ChangeEventArgs e)
    {
        Backend.RpcScheme = e.Value?.ToString() ?? "https";
        Backend.ApplySettings();
    }

    private void OnRpcHostChanged(ChangeEventArgs e)
    {
        Backend.RpcHost = e.Value?.ToString() ?? "";
        Backend.ApplySettings();
    }

    private void OnRpcPortChanged(ChangeEventArgs e)
    {
        Backend.RpcPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443;
        Backend.ApplySettings();
    }

    private void OnBobSchemeChanged(ChangeEventArgs e)
    {
        Backend.BobScheme = e.Value?.ToString() ?? "https";
        Backend.ApplySettings();
    }

    private void OnBobHostChanged(ChangeEventArgs e)
    {
        Backend.BobHost = e.Value?.ToString() ?? "";
        Backend.ApplySettings();
    }

    private void OnBobPortChanged(ChangeEventArgs e)
    {
        Backend.BobPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443;
        Backend.ApplySettings();
    }

    private void OnNodeHostChanged(ChangeEventArgs e)
    {
        Backend.NodeHost = e.Value?.ToString() ?? "";
        Backend.ApplySettings();
    }

    private void OnNodePortChanged(ChangeEventArgs e)
    {
        Backend.NodePort = int.TryParse(e.Value?.ToString(), out var v) ? v : 21841;
        Backend.ApplySettings();
    }

    private async Task OnRemoteLabelsToggled(ChangeEventArgs e)
    {
        Cfg.RemoteLabelsEnabled = (bool)(e.Value ?? false);
        if (Cfg.RemoteLabelsEnabled)
            await RefreshLabels();
        else
            StaticData.Clear();
    }

    private async Task RefreshLabels()
    {
        await StaticData.LoadAsync();
        StateHasChanged();
    }
}
