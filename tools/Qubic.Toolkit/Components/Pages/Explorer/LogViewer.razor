@page "/explorer/logs"
@inject QubicBackendService Backend

<h4>Log Viewer</h4>
<p class="text-muted">View contract logs by contract index and log ID range. (Bob only)</p>

<div class="row mb-3">
    <div class="col-md-8">
        <div class="row g-2">
            <div class="col-3">
                <label class="form-label-sm">Contract</label>
                <select class="form-select form-select-sm" @bind="_contractIndex">
                    @foreach (var c in Qubic.Core.QubicContracts.GetAllContracts())
                    {
                        <option value="@c.Index">@c.Name (@c.Index)</option>
                    }
                </select>
            </div>
            <div class="col-3">
                <label class="form-label-sm">Start Log ID (optional)</label>
                <input type="number" class="form-control form-control-sm" @bind="_startLogId" />
            </div>
            <div class="col-3">
                <label class="form-label-sm">End Log ID (optional)</label>
                <input type="number" class="form-control form-control-sm" @bind="_endLogId" />
            </div>
            <div class="col-3 d-flex align-items-end">
                <button class="btn btn-primary btn-sm" @onclick="Lookup" disabled="@_loading">
                    @(_loading ? "Loading..." : "Fetch Logs")
                </button>
            </div>
        </div>
    </div>
</div>

@if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}

@if (_logs != null)
{
    <div class="card">
        <div class="card-header">Logs (@_logs.Count)</div>
        <div class="card-body" style="max-height:600px; overflow-y:auto">
            @if (_logs.Count == 0)
            {
                <span class="text-muted">No logs found.</span>
            }
            else
            {
                <DataTable Items="_logs">
                    <DataColumn TItem="Qubic.Bob.Models.BobLogEntry" Title="Log ID" Field="@(l => l.LogId)" />
                    <DataColumn TItem="Qubic.Bob.Models.BobLogEntry" Title="Tick" Field="@(l => l.Tick)" DefaultSort="true" DefaultDescending="true" />
                    <DataColumn TItem="Qubic.Bob.Models.BobLogEntry" Title="Contract" Field="@(l => Qubic.Core.QubicContracts.FormatContract(l.ContractIndex))" Filterable="true" />
                    <DataColumn TItem="Qubic.Bob.Models.BobLogEntry" Title="Event Type" Field="@(l => l.EventType)" Filterable="true" />
                    <DataColumn TItem="Qubic.Bob.Models.BobLogEntry" Title="Data" Field="@(l => l.Data ?? "")" Sortable="false">
                        <span class="mono small" style="max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block"
                              title="@context.Data">@(context.Data ?? "")</span>
                    </DataColumn>
                </DataTable>
            }
        </div>
    </div>
}

@code {
    private int _contractIndex;
    private long? _startLogId;
    private long? _endLogId;
    private List<Qubic.Bob.Models.BobLogEntry>? _logs;
    private bool _loading;
    private string? _error;

    private async Task Lookup()
    {
        _loading = true;
        _error = null;
        _logs = null;

        try
        {
            _logs = await Backend.GetLogsAsync(_contractIndex, _startLogId, _endLogId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
