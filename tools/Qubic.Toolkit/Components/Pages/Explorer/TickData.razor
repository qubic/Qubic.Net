@page "/explorer/tick"
@inject QubicBackendService Backend
@inject TickMonitorService TickMonitor

<h4>Tick Data</h4>
<p class="text-muted">View tick details and transactions. (RPC only)</p>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="number" class="form-control" placeholder="Tick number" @bind="_tickNumber" />
            <button class="btn btn-primary" @onclick="Lookup" disabled="@_loading">
                @(_loading ? "Loading..." : "Lookup")
            </button>
        </div>
    </div>
</div>

@if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}

@if (_tickData != null)
{
    <div class="card mb-3">
        <div class="card-header">Tick @_tickData.TickNumber</div>
        <div class="card-body">
            <table class="table table-sm output-table mb-0">
                <tr><td>Tick</td><td class="mono">@_tickData.TickNumber</td></tr>
                <tr><td>Epoch</td><td class="mono">@_tickData.Epoch</td></tr>
                <tr><td>Computor Index</td><td class="mono">@_tickData.ComputorIndex</td></tr>
                <tr><td>Timestamp</td><td class="mono">@_tickData.Timestamp</td></tr>
                <tr><td>Transactions</td><td class="mono">@_tickData.TransactionHashes.Count</td></tr>
                @if (_tickData.ContractFees.Count > 0)
                {
                    <tr><td>Contract Fees</td><td class="mono">@string.Join(", ", _tickData.ContractFees)</td></tr>
                }
            </table>
        </div>
    </div>
}

@if (_transactions != null)
{
    <div class="card">
        <div class="card-header">Transactions in Tick (@_transactions.Count)</div>
        <div class="card-body">
            @if (_transactions.Count == 0)
            {
                <span class="text-muted">No transactions in this tick.</span>
            }
            else
            {
                <DataTable Items="_transactions">
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Hash" Field="@(tx => tx.Hash)" Sortable="false">
                        <span class="mono small">@context.Hash[..16]...</span>
                    </DataColumn>
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Source" Field="@(tx => tx.Source)" Filterable="true">
                        <AddressDisplay Address="@context.Source" />
                    </DataColumn>
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Destination" Field="@(tx => tx.Destination)" Filterable="true">
                        <AddressDisplay Address="@context.Destination" />
                    </DataColumn>
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Amount" Field="@(tx => tx.Amount)" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Type" Field="@(tx => tx.InputType)" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.TransactionInfo" Title="Money Flew" Field="@(tx => tx.MoneyFlew == true ? "Yes" : tx.MoneyFlew == false ? "No" : "")">
                        @if (context.MoneyFlew == true)
                        {
                            <span class="badge bg-success">Yes</span>
                        }
                        else if (context.MoneyFlew == false)
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </DataColumn>
                </DataTable>
            }
        </div>
    </div>
}

@if (!_loading && _tickData == null && _searched)
{
    <div class="alert alert-warning">Tick not found.</div>
}

@code {
    private uint _tickNumber;
    private Qubic.Rpc.Models.TickDataInfo? _tickData;

    protected override void OnInitialized()
    {
        if (TickMonitor.Tick > 0)
            _tickNumber = TickMonitor.Tick;
    }
    private IReadOnlyList<Qubic.Rpc.Models.TransactionInfo>? _transactions;
    private bool _loading;
    private string? _error;
    private bool _searched;

    private async Task Lookup()
    {
        if (_tickNumber == 0) return;

        _loading = true;
        _error = null;
        _tickData = null;
        _transactions = null;
        _searched = true;

        try
        {
            var dataTask = Backend.GetTickDataAsync(_tickNumber);
            var txTask = Backend.GetTransactionsForTickAsync(_tickNumber);
            await Task.WhenAll(dataTask, txTask);

            _tickData = dataTask.Result;
            _transactions = txTask.Result;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
