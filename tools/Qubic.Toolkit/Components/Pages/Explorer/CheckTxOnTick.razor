@page "/explorer/checktx"
@inject QubicBackendService Backend
@inject TickMonitorService TickMonitor

<h4>Check Tx on Tick</h4>
<p class="text-muted">Verify whether a transaction exists in a specific tick. (RPC only)</p>

<div class="row mb-3">
    <div class="col-md-8">
        <div class="mb-2">
            <label class="form-label-sm">Tick Number</label>
            <input type="number" class="form-control form-control-sm" @bind="_tickNumber" />
        </div>
        <div class="mb-2">
            <label class="form-label-sm">Transaction Hash</label>
            <input class="form-control form-control-sm mono" @bind="_txHash" placeholder="64-char hex transaction ID" />
        </div>
        <button class="btn btn-sm btn-primary" @onclick="Check" disabled="@_loading">
            @(_loading ? "Checking..." : "Check")
        </button>
    </div>
</div>

@if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}

@if (_searched && !_loading)
{
    @if (_match != null)
    {
        <div class="alert alert-success">
            <span class="badge bg-success me-2">Found</span>
            Transaction exists in tick @_tickNumber.
        </div>
        <div class="card">
            <div class="card-header">Transaction Details</div>
            <div class="card-body">
                <table class="table table-sm output-table mb-0">
                    <tr><td>Hash</td><td class="mono small">@_match.Hash</td></tr>
                    <tr><td>Source</td><td class="mono small">@_match.Source</td></tr>
                    <tr><td>Destination</td><td class="mono small">@_match.Destination</td></tr>
                    <tr><td>Amount</td><td class="mono">@_match.Amount</td></tr>
                    <tr><td>Input Type</td><td class="mono">@_match.InputType</td></tr>
                    @if (_match.MoneyFlew != null)
                    {
                        <tr>
                            <td>Money Flew</td>
                            <td>
                                @if (_match.MoneyFlew == true)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">No</span>
                                }
                            </td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <span class="badge bg-danger me-2">Not Found</span>
            Transaction not found in tick @_tickNumber.
            @if (_txCount.HasValue)
            {
                <span class="text-muted ms-2">(@_txCount transactions in this tick)</span>
            }
        </div>
    }
}

@code {
    private uint _tickNumber;
    private string? _txHash;
    private Qubic.Rpc.Models.TransactionInfo? _match;
    private int? _txCount;
    private bool _loading;
    private bool _searched;
    private string? _error;

    protected override void OnInitialized()
    {
        if (TickMonitor.Tick > 0)
            _tickNumber = TickMonitor.Tick;
    }

    private async Task Check()
    {
        if (_tickNumber == 0 || string.IsNullOrWhiteSpace(_txHash)) return;

        _loading = true;
        _error = null;
        _match = null;
        _txCount = null;
        _searched = true;

        try
        {
            var transactions = await Backend.GetTransactionsForTickAsync(_tickNumber);
            _txCount = transactions.Count;
            _match = transactions.FirstOrDefault(t =>
                string.Equals(t.Hash, _txHash.Trim(), StringComparison.OrdinalIgnoreCase));
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
