@page "/contracts/browser"
@inject ContractDiscovery Discovery
@inject QubicBackendService Backend

<h4>Smart Contract Browser</h4>
<p class="text-muted">Browse and query all discovered smart contract functions.</p>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Summary</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr><td class="text-muted">Contracts</td><td><strong>@Discovery.Contracts.Count</strong></td></tr>
                    <tr><td class="text-muted">Total Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count)</strong></td></tr>
                    <tr><td class="text-muted">Empty-Input Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count(f => f.IsEmptyInput))</strong></td></tr>
                    <tr><td class="text-muted">Parameterized Functions</td><td><strong>@Discovery.Contracts.Sum(c => c.Functions.Count(f => !f.IsEmptyInput))</strong></td></tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Connection Test</div>
            <div class="card-body">
                <button class="btn btn-sm btn-primary" @onclick="TestConnection" disabled="@_testing">
                    @(_testing ? "Testing..." : "Test SC Query")
                </button>
                @if (_testResult != null)
                {
                    <span class="ms-2 badge @(_testSuccess ? "bg-success" : "bg-danger")">@_testResult</span>
                }
            </div>
        </div>
    </div>
</div>

<h5>Contracts</h5>
<DataTable Items="Discovery.Contracts">
    <DataColumn TItem="ContractInfo" Title="Contract" Field="@(c => Qubic.Core.QubicContracts.FormatContract(c.ContractIndex))" />
    <DataColumn TItem="ContractInfo" Title="Name" Field="@(c => c.Name)" Filterable="true">
        <strong>@context.Name</strong>
    </DataColumn>
    <DataColumn TItem="ContractInfo" Title="Functions" Field="@(c => c.Functions.Count)" />
    <DataColumn TItem="ContractInfo" Title="Empty-Input" Field="@(c => c.Functions.Count(f => f.IsEmptyInput))" />
    <DataColumn TItem="ContractInfo" Title="" Sortable="false">
        <a href="/contracts/@context.ContractIndex" class="btn btn-sm btn-outline-primary">Open</a>
    </DataColumn>
</DataTable>

@code {
    private bool _testing;
    private bool _testSuccess;
    private string? _testResult;

    private async Task TestConnection()
    {
        _testing = true;
        _testResult = null;
        try
        {
            await Backend.QuerySmartContractAsync(4, 1, []);
            _testSuccess = true;
            _testResult = "Connected";
        }
        catch (Exception ex)
        {
            _testSuccess = false;
            _testResult = ex.Message.Length > 80 ? ex.Message[..80] + "..." : ex.Message;
        }
        finally
        {
            _testing = false;
        }
    }
}
