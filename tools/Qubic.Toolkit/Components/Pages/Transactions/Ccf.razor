@page "/tx/ccf"
@using System.Buffers.Binary
@using Qubic.Core.Contracts.Ccf
@using Qubic.Core.Entities
@using Qubic.Core.Payloads
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject QubicSettingsService Settings
@inject IJSRuntime JS

<h4><i class="bi bi-currency-exchange me-2"></i>Computor-Controlled Fund (CCF)</h4>
<p class="text-muted">CCF proposals, voting, transfers, and subscription management (Contract 8).</p>

<ul class="nav nav-tabs mb-3">
    @foreach (var tab in _tabs)
    {
        <li class="nav-item">
            <a class="nav-link @(tab == _activeTab ? "active" : "")" href="" @onclick="() => SetTab(tab)" @onclick:preventDefault>@tab</a>
        </li>
    }
</ul>

@switch (_activeTab)
{
    // ══════════════════════════════════════════════════════════
    // BROWSE — list and inspect proposals
    // ══════════════════════════════════════════════════════════
    case "Browse":
        <div class="mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" checked="@(_browseMode == 0)" @onchange="() => { _browseMode = 0; _browseIndices = null; }" />
                <label class="form-check-label">Active (current epoch)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" checked="@(_browseMode == 1)" @onchange="() => { _browseMode = 1; _browseIndices = null; }" />
                <label class="form-check-label">Finished</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" checked="@(_browseMode == 2)" @onchange="() => { _browseMode = 2; _browseIndices = null; }" />
                <label class="form-check-label">By Index</label>
            </div>
        </div>
        @if (_browseMode == 2)
        {
            <div class="row g-2 mb-3">
                <div class="col-auto">
                    <input type="number" class="form-control form-control-sm" @bind="_browseSingleIndex" min="0" placeholder="Proposal index" />
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary btn-sm" @onclick="LoadSingleProposal" disabled="@_loading">
                        @(_loading ? "Loading..." : "Load Proposal")
                    </button>
                </div>
            </div>
        }
        else
        {
            <button class="btn btn-primary btn-sm" @onclick="LoadProposalIndices" disabled="@_loading">
                @(_loading ? "Loading..." : "Load Proposals")
            </button>
        }

        @if (_browseIndices != null)
        {
            <div class="mt-3">
                @if (_browseIndices.Count == 0)
                {
                    <div class="text-muted">No proposals found.</div>
                }
                else
                {
                    <table class="table table-sm table-hover">
                        <thead><tr><th style="width:60px">Index</th><th>Proposer</th><th style="width:60px">Epoch</th><th>Destination</th><th>Amount (QU)</th><th>URL</th><th style="width:30px"></th></tr></thead>
                        <tbody>
                            @foreach (var idx in _browseIndices)
                            {
                                var localIdx = idx;
                                var p = _browseProposals.GetValueOrDefault(idx);
                                <tr @onclick="() => ToggleExpand(localIdx)" style="cursor:pointer">
                                    <td>@idx</td>
                                    <td class="mono small">@(p != null ? TruncateId(p.Proposer) : "...")</td>
                                    <td>@(p?.Epoch.ToString() ?? "...")</td>
                                    <td class="mono small">@(p != null ? TruncateId(p.Destination) : "...")</td>
                                    <td>@(p != null ? p.Amount.ToString("N0") : "...")</td>
                                    <td class="small text-truncate" style="max-width:200px">@(p?.Url ?? "...")</td>
                                    <td><i class="bi @(_expandedIndex == idx ? "bi-chevron-up" : "bi-chevron-down")"></i></td>
                                </tr>
                                @if (_expandedIndex == idx && p != null)
                                {
                                    <tr><td colspan="7">
                                        <div class="card card-body bg-light small">
                                            <div class="row g-2">
                                                <div class="col-12"><strong>Proposer:</strong> <span class="mono">@p.Proposer</span></div>
                                                <div class="col-md-6"><strong>Type:</strong> @GetTypeLabel(p.Type) (0x@(p.Type.ToString("X4")))</div>
                                                <div class="col-md-3"><strong>Tick:</strong> @p.Tick</div>
                                                <div class="col-md-3"><strong>Epoch:</strong> @p.Epoch</div>
                                                <div class="col-12"><strong>Destination:</strong> <span class="mono">@p.Destination</span></div>
                                                <div class="col-md-6"><strong>Amount:</strong> @p.Amount.ToString("N0") QU</div>
                                                <div class="col-12"><strong>URL:</strong>
                                                    @if (!string.IsNullOrEmpty(p.Url))
                                                    {
                                                        <a href="@p.Url" target="_blank" rel="noopener">@p.Url</a>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">(none)</span>
                                                    }
                                                </div>
                                                @if (p.HasSubscriptionProposal)
                                                {
                                                    <div class="col-12 mt-2"><strong class="text-info">Subscription Proposal</strong></div>
                                                    <div class="col-md-6"><strong>Sub. Proposer:</strong> <span class="mono small">@TruncateId(p.SubProposal!.ProposerId)</span></div>
                                                    <div class="col-md-6"><strong>Sub. Destination:</strong> <span class="mono small">@TruncateId(p.SubProposal!.Destination)</span></div>
                                                    <div class="col-md-4"><strong>Weeks/Period:</strong> @p.SubProposal!.WeeksPerPeriod</div>
                                                    <div class="col-md-4"><strong>Periods:</strong> @p.SubProposal!.NumberOfPeriods</div>
                                                    <div class="col-md-4"><strong>Amount/Period:</strong> @p.SubProposal!.AmountPerPeriod.ToString("N0") QU</div>
                                                    <div class="col-md-4"><strong>Start Epoch:</strong> @p.SubProposal!.StartEpoch</div>
                                                }
                                                @if (p.HasActiveSubscription)
                                                {
                                                    <div class="col-12 mt-2"><strong class="text-success">Active Subscription</strong></div>
                                                    <div class="col-md-6"><strong>Sub. Destination:</strong> <span class="mono small">@TruncateId(p.Subscription!.Destination)</span></div>
                                                    <div class="col-md-4"><strong>Weeks/Period:</strong> @p.Subscription!.WeeksPerPeriod</div>
                                                    <div class="col-md-4"><strong>Periods:</strong> @p.Subscription!.NumberOfPeriods</div>
                                                    <div class="col-md-4"><strong>Amount/Period:</strong> @p.Subscription!.AmountPerPeriod.ToString("N0") QU</div>
                                                    <div class="col-md-4"><strong>Start Epoch:</strong> @p.Subscription!.StartEpoch</div>
                                                    <div class="col-md-4"><strong>Current Period:</strong> @p.Subscription!.CurrentPeriod</div>
                                                }
                                            </div>
                                        </div>
                                    </td></tr>
                                }
                            }
                        </tbody>
                    </table>
                    @if (_browseMode != 2 && _browseIndices.Count >= 64)
                    {
                        <button class="btn btn-outline-primary btn-sm" @onclick="LoadMoreProposals" disabled="@_loading">Load More</button>
                    }
                }
            </div>
        }
        break;

    // ══════════════════════════════════════════════════════════
    // PROPOSE — set or clear a CCF proposal
    // ══════════════════════════════════════════════════════════
    case "Propose":
        @if (!Seed.HasSeed)
        {
            <div class="seed-warning">Enter your seed in the top bar to enable signing.</div>
        }
        else
        {
            <div class="row"><div class="col-md-8">
                <div class="card"><div class="card-body">
                    @if (_proposalFee > 0)
                    {
                        <div class="alert alert-info small mb-3">Proposal fee: <strong>@_proposalFee.ToString("N0") QU</strong> (auto-fetched, sent as transaction amount)</div>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary btn-sm mb-3" @onclick="LoadProposalFee" disabled="@_loading">Load Proposal Fee</button>
                    }
                    <p class="small text-muted">CCF only supports Transfer: Yes/No (0x0102) proposals.</p>
                    <div class="mb-3">
                        <label class="form-label">Proposal URL <small class="text-muted">(max 255 chars)</small></label>
                        <input class="form-control form-control-sm" @bind="_propUrl" maxlength="255" placeholder="https://..." />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Destination Identity</label>
                        <input class="form-control form-control-sm mono @IdentityValidation.CssClass(_propDest)"
                               @bind="_propDest" @bind:event="oninput" placeholder="IDENTITY..." />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (QU)</label>
                        <input type="number" class="form-control form-control-sm" @bind="_propAmount" min="0" />
                    </div>
                    @if (TickMonitor.IsConnected)
                    {
                        <div class="mb-3 small text-muted">Epoch: @TickMonitor.Epoch (auto-detected)</div>
                    }

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="_propIsSub" id="subCheck" />
                            <label class="form-check-label" for="subCheck">Subscription proposal</label>
                        </div>
                    </div>
                    @if (_propIsSub)
                    {
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Weeks/Period</label>
                                <input type="number" class="form-control form-control-sm" @bind="_propWeeksPerPeriod" min="1" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Start Epoch</label>
                                <input type="number" class="form-control form-control-sm" @bind="_propStartEpoch" min="0" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Amount/Period (QU)</label>
                                <input type="number" class="form-control form-control-sm" @bind="_propAmountPerPeriod" min="0" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"># of Periods</label>
                                <input type="number" class="form-control form-control-sm" @bind="_propNumPeriods" min="0" />
                            </div>
                        </div>
                        @if ((uint)_propWeeksPerPeriod * (uint)_propNumPeriods > 52)
                        {
                            <div class="alert alert-warning small">Total duration @((uint)_propWeeksPerPeriod * (uint)_propNumPeriods) epochs exceeds max 52.</div>
                        }
                    }

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" @onclick="SubmitProposal" disabled="@_sending">
                            @(_sending ? "Sending..." : "Set Proposal")
                        </button>
                        <button class="btn btn-outline-danger" @onclick="ClearProposal" disabled="@_sending">Clear My Proposal</button>
                    </div>
                </div></div>
            </div></div>
        }
        break;

    // ══════════════════════════════════════════════════════════
    // VOTE — cast or clear a vote
    // ══════════════════════════════════════════════════════════
    case "Vote":
        @if (!Seed.HasSeed)
        {
            <div class="seed-warning">Enter your seed in the top bar to enable signing.</div>
        }
        else
        {
            <div class="row"><div class="col-md-8">
                <div class="card"><div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Proposal Index</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" @bind="_voteProposalIndex" min="0" />
                            <button class="btn btn-outline-primary" @onclick="LoadVoteProposal" disabled="@_loading">
                                @(_loading ? "Loading..." : "Load Proposal")
                            </button>
                        </div>
                    </div>

                    @if (_voteProposal != null)
                    {
                        <div class="alert alert-info small mb-3">
                            <strong>@GetTypeLabel(_voteProposal.Type)</strong> (0x@(_voteProposal.Type.ToString("X4")))<br />
                            Tick: @_voteProposal.Tick &bull; Epoch: @_voteProposal.Epoch<br />
                            Destination: <span class="mono">@TruncateId(_voteProposal.Destination)</span> &bull;
                            Amount: @_voteProposal.Amount.ToString("N0") QU<br />
                            @if (!string.IsNullOrEmpty(_voteProposal.Url))
                            {
                                <text>URL: <a href="@_voteProposal.Url" target="_blank" rel="noopener">@_voteProposal.Url</a></text>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Vote Value</label>
                            <select class="form-select form-select-sm" @bind="_voteValue">
                                <option value="0">0 — No Change</option>
                                <option value="1">1 — Yes (Approve)</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @onclick="SubmitVote" disabled="@_sending">
                                @(_sending ? "Sending..." : "Cast Vote")
                            </button>
                            <button class="btn btn-outline-danger" @onclick="ClearVote" disabled="@_sending">Clear Vote</button>
                        </div>
                    }
                </div></div>
            </div></div>
        }
        break;

    // ══════════════════════════════════════════════════════════
    // RESULTS — view voting results
    // ══════════════════════════════════════════════════════════
    case "Results":
        <div class="row"><div class="col-md-8">
            <div class="mb-3">
                <label class="form-label">Proposal Index</label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" @bind="_resultsIndex" min="0" />
                    <button class="btn btn-outline-primary" @onclick="LoadResults" disabled="@_loading">
                        @(_loading ? "Loading..." : "Load Results")
                    </button>
                </div>
            </div>

            @if (_resultsData != null)
            {
                <div class="card card-body">
                    <div class="row g-2 small mb-3">
                        <div class="col-6"><strong>Proposal Index:</strong> @_resultsData.ProposalIndex</div>
                        <div class="col-6"><strong>Tick:</strong> @_resultsData.Tick</div>
                        <div class="col-6"><strong>Authorized Voters:</strong> @_resultsData.TotalAuthorized</div>
                        <div class="col-6"><strong>Votes Cast:</strong> @_resultsData.TotalCast</div>
                    </div>

                    @if (_resultsData.OptionCount > 0)
                    {
                        <h6>Option Votes</h6>
                        @for (int i = 0; i < _resultsData.OptionCount && i < 8; i++)
                        {
                            var ri = i;
                            var votes = _resultsData.OptionVotes[ri];
                            var pct = _resultsData.TotalCast > 0 ? 100.0 * votes / _resultsData.TotalCast : 0;
                            <div class="d-flex align-items-center gap-2 mb-1 small">
                                <span style="width:100px">@(ri == 0 ? "No Change" : ri == 1 ? "Yes (Approve)" : $"Option {ri}")</span>
                                <div class="progress flex-grow-1" style="height:20px">
                                    <div class="progress-bar @(ri == 0 ? "bg-secondary" : "bg-success")" style="width:@(Math.Max(pct, 0.5).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%">
                                        @votes (@(pct.ToString("F1"))%)
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <h6>Scalar Result</h6>
                        <div class="fs-4">@_resultsData.ScalarResult</div>
                    }
                </div>
            }
        </div></div>
        break;

    // ══════════════════════════════════════════════════════════
    // GET VOTE — check a specific voter's vote
    // ══════════════════════════════════════════════════════════
    case "Get Vote":
        <div class="row"><div class="col-md-8">
            <div class="row g-2 mb-3">
                <div class="col-3">
                    <label class="form-label">Proposal Index</label>
                    <input type="number" class="form-control form-control-sm" @bind="_getVoteIndex" min="0" />
                </div>
                <div class="col">
                    <label class="form-label">Voter Identity <small class="text-muted">(blank = your identity)</small></label>
                    <input class="form-control form-control-sm mono @IdentityValidation.CssClass(_getVoteIdentity)"
                           @bind="_getVoteIdentity" @bind:event="oninput" placeholder="IDENTITY..." />
                </div>
            </div>
            <button class="btn btn-outline-primary btn-sm" @onclick="LoadVote" disabled="@_loading">
                @(_loading ? "Loading..." : "Load Vote")
            </button>

            @if (_getVoteData != null)
            {
                <div class="card card-body mt-3 small">
                    <div class="row g-2">
                        <div class="col-6"><strong>Proposal Index:</strong> @_getVoteData.ProposalIndex</div>
                        <div class="col-6"><strong>Type:</strong> @GetTypeLabel(_getVoteData.ProposalType) (0x@(_getVoteData.ProposalType.ToString("X4")))</div>
                        <div class="col-6"><strong>Proposal Tick:</strong> @_getVoteData.ProposalTick</div>
                        <div class="col-6"><strong>Vote Value:</strong>
                            @if (_getVoteData.VoteValue == long.MinValue)
                            {
                                <span class="text-muted">No vote / cleared</span>
                            }
                            else if (_getVoteData.VoteValue == 0)
                            {
                                <span>0 (No Change)</span>
                            }
                            else if (_getVoteData.VoteValue == 1)
                            {
                                <span class="text-success">1 (Yes / Approve)</span>
                            }
                            else
                            {
                                <span>@_getVoteData.VoteValue</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div></div>
        break;

    // ══════════════════════════════════════════════════════════
    // SUBSCRIPTIONS — look up active subscription
    // ══════════════════════════════════════════════════════════
    case "Subscriptions":
        <div class="row"><div class="col-md-8">
            <p class="small text-muted">Look up an active subscription by its destination identity.</p>
            <div class="mb-3">
                <label class="form-label">Destination Identity</label>
                <div class="input-group input-group-sm">
                    <input class="form-control mono @IdentityValidation.CssClass(_subLookupDest)"
                           @bind="_subLookupDest" @bind:event="oninput" placeholder="IDENTITY..." />
                    <button class="btn btn-outline-primary" @onclick="LoadSubscription" disabled="@_loading">
                        @(_loading ? "Loading..." : "Lookup")
                    </button>
                </div>
            </div>

            @if (_subResult != null)
            {
                @if (!_subResult.Found)
                {
                    <div class="text-muted">No active subscription found for this destination.</div>
                }
                else
                {
                    <div class="card card-body small">
                        <div class="row g-2">
                            <div class="col-12"><strong>Destination:</strong> <span class="mono">@_subResult.Destination</span></div>
                            <div class="col-12"><strong>URL:</strong>
                                @if (!string.IsNullOrEmpty(_subResult.Url))
                                {
                                    <a href="@_subResult.Url" target="_blank" rel="noopener">@_subResult.Url</a>
                                }
                                else
                                {
                                    <span class="text-muted">(none)</span>
                                }
                            </div>
                            <div class="col-md-4"><strong>Weeks/Period:</strong> @_subResult.WeeksPerPeriod</div>
                            <div class="col-md-4"><strong># of Periods:</strong> @_subResult.NumberOfPeriods</div>
                            <div class="col-md-4"><strong>Amount/Period:</strong> @_subResult.AmountPerPeriod.ToString("N0") QU</div>
                            <div class="col-md-4"><strong>Start Epoch:</strong> @_subResult.StartEpoch</div>
                            <div class="col-md-4"><strong>Current Period:</strong> @_subResult.CurrentPeriod</div>
                        </div>
                    </div>
                }
            }
        </div></div>
        break;

    // ══════════════════════════════════════════════════════════
    // TRANSFERS — latest one-time transfers
    // ══════════════════════════════════════════════════════════
    case "Transfers":
        <div>
            <p class="small text-muted">Recent one-time transfers approved by quorum.</p>
            <button class="btn btn-outline-primary btn-sm" @onclick="LoadTransfers" disabled="@_loading">
                @(_loading ? "Loading..." : "Load Latest Transfers")
            </button>

            @if (_transfers != null)
            {
                <div class="mt-3">
                    @if (_transfers.Count == 0)
                    {
                        <div class="text-muted">No transfers found.</div>
                    }
                    else
                    {
                        <DataTable Items="_transfers" ShowRowNumbers="true">
                            <DataColumn TItem="TransferEntry" Title="Destination" Field="@(t => t.Destination)" Filterable="true">
                                <AddressDisplay Address="@context.Destination" />
                            </DataColumn>
                            <DataColumn TItem="TransferEntry" Title="Amount (QU)" Field="@(t => t.Amount)" Format="N0" />
                            <DataColumn TItem="TransferEntry" Title="Tick" Field="@(t => t.Tick)" DefaultSort="true" DefaultDescending="true" />
                            <DataColumn TItem="TransferEntry" Title="Success" Field="@(t => t.Success ? "Yes" : "No")" />
                            <DataColumn TItem="TransferEntry" Title="URL" Field="@(t => t.Url)" Sortable="false">
                                @if (!string.IsNullOrEmpty(context.Url))
                                {
                                    <a href="#" class="small text-truncate d-inline-block" style="max-width:200px"
                                       @onclick="() => ConfirmOpenUrl(context.Url)" @onclick:preventDefault
                                       title="@context.Url">@context.Url</a>
                                }
                            </DataColumn>
                        </DataTable>
                    }
                </div>
            }
        </div>
        break;

    // ══════════════════════════════════════════════════════════
    // PAYMENTS — regular subscription payments
    // ══════════════════════════════════════════════════════════
    case "Payments":
        <div>
            <p class="small text-muted">Recent subscription (regular) payments made by the CCF contract.</p>
            <button class="btn btn-outline-primary btn-sm" @onclick="LoadPayments" disabled="@_loading">
                @(_loading ? "Loading..." : "Load Regular Payments")
            </button>

            @if (_payments != null)
            {
                <div class="mt-3">
                    @if (_payments.Count == 0)
                    {
                        <div class="text-muted">No regular payments found.</div>
                    }
                    else
                    {
                        <DataTable Items="_payments" ShowRowNumbers="true">
                            <DataColumn TItem="PaymentEntry" Title="Destination" Field="@(p => p.Destination)" Filterable="true">
                                <AddressDisplay Address="@context.Destination" />
                            </DataColumn>
                            <DataColumn TItem="PaymentEntry" Title="Amount (QU)" Field="@(p => p.Amount)" Format="N0" />
                            <DataColumn TItem="PaymentEntry" Title="Tick" Field="@(p => p.Tick)" DefaultSort="true" DefaultDescending="true" />
                            <DataColumn TItem="PaymentEntry" Title="Period" Field="@(p => p.PeriodIndex)" />
                            <DataColumn TItem="PaymentEntry" Title="Success" Field="@(p => p.Success ? "Yes" : "No")" />
                            <DataColumn TItem="PaymentEntry" Title="URL" Field="@(p => p.Url)" Sortable="false">
                                @if (!string.IsNullOrEmpty(context.Url))
                                {
                                    <a href="#" class="small text-truncate d-inline-block" style="max-width:200px"
                                       @onclick="() => ConfirmOpenUrl(context.Url)" @onclick:preventDefault
                                       title="@context.Url">@context.Url</a>
                                }
                            </DataColumn>
                        </DataTable>
                    }
                </div>
            }
        </div>
        break;
}

<ConfirmDialog @ref="_confirmDialog" Title="Open external URL?" IconClass="bi-shield-exclamation" ConfirmText="Open" />

@if (_result != null)
{
    <div class="alert alert-success mt-3">
        Transaction broadcast! Tx ID: <span class="mono">@_result</span>
        <div class="mt-1">
            <a href="https://explorer.qubic.org/network/tx/@_result" target="_blank" rel="noopener" class="me-3">View on Explorer</a>
            <a href="/tx/history">Transaction History</a>
        </div>
    </div>
}
@if (_error != null)
{
    <div class="alert alert-danger mt-2">@_error</div>
}

@code {
    // ── Constants ──
    const uint CcfIndex = 8;
    const long NO_VOTE_VALUE = long.MinValue;

    // ── Tab state ──
    static readonly string[] _tabs = ["Browse", "Propose", "Vote", "Results", "Get Vote", "Subscriptions", "Transfers", "Payments"];
    string _activeTab = "Browse";
    string? _error;
    string? _result;
    bool _sending;
    bool _loading;

    // ── Browse ──
    int _browseMode; // 0=active, 1=finished, 2=by index
    int _browseSingleIndex;
    List<ushort>? _browseIndices;
    Dictionary<ushort, CcfParsedProposal> _browseProposals = new();
    ushort? _expandedIndex;

    // ── Propose ──
    uint _proposalFee;
    string _propUrl = "";
    string _propDest = "";
    long _propAmount;
    bool _propIsSub;
    int _propWeeksPerPeriod = 1;
    uint _propStartEpoch;
    ulong _propAmountPerPeriod;
    uint _propNumPeriods;

    // ── Vote ──
    int _voteProposalIndex;
    CcfParsedProposal? _voteProposal;
    string _voteValue = "0";

    // ── Results ──
    int _resultsIndex;
    ParsedResults? _resultsData;

    // ── Get Vote ──
    int _getVoteIndex;
    string _getVoteIdentity = "";
    ParsedVote? _getVoteData;

    // ── Subscriptions ──
    string _subLookupDest = "";
    SubscriptionResult? _subResult;

    // ── Transfers ──
    List<TransferEntry>? _transfers;

    // ── Payments ──
    List<PaymentEntry>? _payments;

    // ── URL confirm ──
    ConfirmDialog _confirmDialog = null!;

    // ── Records ──
    record CcfParsedProposal(ushort Index, string Proposer, string Url, ushort Epoch, ushort Type, uint Tick,
        string Destination, long Amount, bool HasSubscriptionProposal, bool HasActiveSubscription,
        SubProposalInfo? SubProposal, SubscriptionInfo? Subscription);
    record SubProposalInfo(string ProposerId, string Destination, string Url, byte WeeksPerPeriod, uint NumberOfPeriods, ulong AmountPerPeriod, uint StartEpoch);
    record SubscriptionInfo(string Destination, string Url, byte WeeksPerPeriod, uint NumberOfPeriods, ulong AmountPerPeriod, uint StartEpoch, int CurrentPeriod);
    record SubscriptionResult(bool Found, string Destination, string Url, byte WeeksPerPeriod, uint NumberOfPeriods, ulong AmountPerPeriod, uint StartEpoch, int CurrentPeriod);
    record ParsedResults(ushort ProposalIndex, ushort OptionCount, uint Tick, uint TotalAuthorized, uint TotalCast, uint[] OptionVotes, long ScalarResult);
    record ParsedVote(ushort ProposalIndex, ushort ProposalType, uint ProposalTick, long VoteValue);
    record TransferEntry(string Destination, string Url, long Amount, uint Tick, bool Success);
    record PaymentEntry(string Destination, string Url, long Amount, uint Tick, int PeriodIndex, bool Success);

    // ══════════════════════════════════════════════════════════
    // Helpers
    // ══════════════════════════════════════════════════════════

    void SetTab(string tab) { _activeTab = tab; _error = null; _result = null; }

    async Task<uint> GetTick() => TickMonitor.IsConnected
        ? TickMonitor.Tick + (uint)Settings.TickOffset
        : (await Backend.GetTickInfoAsync()).Tick + (uint)Settings.TickOffset;

    static string GetTypeLabel(int type) => type switch
    {
        0x0102 => "Transfer: Yes/No",
        _ => $"Type 0x{type:X4}"
    };

    static string TruncateId(string id) => id.Length > 16 ? id[..8] + "..." + id[^8..] : id;

    static string SafeIdentityFromPk(byte[] pk)
    {
        try { return QubicIdentity.FromPublicKey(pk).ToString(); }
        catch { return Convert.ToHexString(pk)[..16] + "..."; }
    }

    static string SafeUrlFromBytes(ReadOnlySpan<byte> urlBytes)
    {
        int end = urlBytes.IndexOf((byte)0);
        if (end < 0) end = urlBytes.Length;
        return System.Text.Encoding.ASCII.GetString(urlBytes[..end]);
    }

    // ══════════════════════════════════════════════════════════
    // Browse
    // ══════════════════════════════════════════════════════════

    async Task LoadProposalIndices()
    {
        _loading = true; _error = null; _browseProposals.Clear(); _expandedIndex = null;
        try
        {
            var input = new GetProposalIndicesInput { ActiveProposals = _browseMode == 0, PrevProposalIndex = -1 };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 1, input.ToBytes());
            var output = GetProposalIndicesOutput.FromBytes(result);
            _browseIndices = output.Indices.Take(output.NumOfIndices).ToList();
            StateHasChanged();

            foreach (var idx in _browseIndices)
            {
                try { await LoadProposalDetail(idx, new byte[32]); StateHasChanged(); }
                catch { /* skip */ }
            }
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    async Task LoadMoreProposals()
    {
        if (_browseIndices == null || _browseIndices.Count == 0) return;
        _loading = true; _error = null;
        try
        {
            var prevMax = _browseIndices.Max();
            var input = new GetProposalIndicesInput { ActiveProposals = _browseMode == 0, PrevProposalIndex = prevMax };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 1, input.ToBytes());
            var output = GetProposalIndicesOutput.FromBytes(result);
            var newIndices = output.Indices.Take(output.NumOfIndices).ToList();
            _browseIndices.AddRange(newIndices);
            StateHasChanged();

            foreach (var idx in newIndices)
            {
                try { await LoadProposalDetail(idx, new byte[32]); StateHasChanged(); }
                catch { /* skip */ }
            }
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    async Task LoadSingleProposal()
    {
        _loading = true; _error = null; _browseProposals.Clear(); _expandedIndex = null;
        try
        {
            var idx = (ushort)_browseSingleIndex;
            await LoadProposalDetail(idx, new byte[32]);
            _browseIndices = [idx];
            _expandedIndex = idx;
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    async Task LoadProposalDetail(ushort index, byte[] subscriptionDest)
    {
        var input = new GetProposalInput { SubscriptionDestination = subscriptionDest, ProposalIndex = index };
        var result = await Backend.QuerySmartContractAsync(CcfIndex, 2, input.ToBytes());
        var p = ParseCcfProposalResponse(index, result);
        if (p != null)
            _browseProposals[index] = p;
    }

    CcfParsedProposal? ParseCcfProposalResponse(ushort index, byte[] data)
    {
        // GetProposal output: okay(1) + hasSub(1) + hasActive(1) + pad(5) + proposer(32) + ProposalDataYesNo(304) + SubscriptionData(312) + SubscriptionProposalData(340) = 996
        if (data.Length < 344 || data[0] == 0) return null;

        bool hasSP = data[1] != 0;
        bool hasAS = data[2] != 0;

        var proposerPk = data.AsSpan(8, 32).ToArray();
        var proposer = SafeIdentityFromPk(proposerPk);

        // ProposalDataYesNo (304 bytes) at offset 40
        var proposal = data.AsSpan(40, 304);
        var url = SafeUrlFromBytes(proposal[..256]);
        var epoch = BinaryPrimitives.ReadUInt16LittleEndian(proposal[256..]);
        var type = BinaryPrimitives.ReadUInt16LittleEndian(proposal[258..]);
        var tick = BinaryPrimitives.ReadUInt32LittleEndian(proposal[260..]);
        // Data union: destination(32) at 264, amount(8) at 296
        var destPk = proposal.Slice(264, 32).ToArray();
        var destination = SafeIdentityFromPk(destPk);
        var amount = BinaryPrimitives.ReadInt64LittleEndian(proposal[296..]);

        SubProposalInfo? subProp = null;
        SubscriptionInfo? activeSub = null;

        // SubscriptionData (312 bytes) at offset 344
        if (hasAS && data.Length >= 344 + 312)
        {
            var sd = data.AsSpan(344, 312);
            var sdDest = SafeIdentityFromPk(sd[..32].ToArray());
            var sdUrl = SafeUrlFromBytes(sd.Slice(32, 256));
            activeSub = new SubscriptionInfo(sdDest, sdUrl, sd[288],
                BinaryPrimitives.ReadUInt32LittleEndian(sd[292..]),
                BinaryPrimitives.ReadUInt64LittleEndian(sd[296..]),
                BinaryPrimitives.ReadUInt32LittleEndian(sd[304..]),
                BinaryPrimitives.ReadInt32LittleEndian(sd[308..]));
        }

        // SubscriptionProposalData (340 bytes) at offset 656
        if (hasSP && data.Length >= 656 + 340)
        {
            var sp = data.AsSpan(656, 340);
            var spProposer = SafeIdentityFromPk(sp[..32].ToArray());
            var spDest = SafeIdentityFromPk(sp.Slice(32, 32).ToArray());
            var spUrl = SafeUrlFromBytes(sp.Slice(64, 256));
            subProp = new SubProposalInfo(spProposer, spDest, spUrl, sp[320],
                BinaryPrimitives.ReadUInt32LittleEndian(sp[324..]),
                BinaryPrimitives.ReadUInt64LittleEndian(sp[328..]),
                BinaryPrimitives.ReadUInt32LittleEndian(sp[336..]));
        }

        return new CcfParsedProposal(index, proposer, url, epoch, type, tick, destination, amount, hasSP, hasAS, subProp, activeSub);
    }

    async Task ToggleExpand(ushort index)
    {
        if (_expandedIndex == index) { _expandedIndex = null; return; }
        _expandedIndex = index;
        if (!_browseProposals.ContainsKey(index))
        {
            try { await LoadProposalDetail(index, new byte[32]); }
            catch (Exception ex) { _error = ex.Message; }
        }
    }

    // ══════════════════════════════════════════════════════════
    // Propose
    // ══════════════════════════════════════════════════════════

    async Task LoadProposalFee()
    {
        _loading = true; _error = null;
        try
        {
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 6, []);
            _proposalFee = GetProposalFeeOutput.FromBytes(result).ProposalFee;
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    async Task SubmitProposal()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (_proposalFee == 0) await LoadProposalFee();
            if (_proposalFee == 0) throw new InvalidOperationException("Could not determine proposal fee.");

            var payload = BuildProposalPayload();
            await BroadcastCcf(_proposalFee, payload,
                _propIsSub ? "CCF Set Proposal (subscription)" : "CCF Set Proposal");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    async Task ClearProposal()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (_proposalFee == 0) await LoadProposalFee();
            if (_proposalFee == 0) throw new InvalidOperationException("Could not determine proposal fee.");

            // ProposalDataYesNo with epoch=0 (304 bytes) + subscription fields (20 bytes) = 324 bytes, all zeros
            var data = new byte[324];
            await BroadcastCcf(_proposalFee, data, "CCF Clear Proposal");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    byte[] BuildProposalPayload()
    {
        // ProposalDataYesNo (304 bytes) + subscription fields (20 bytes) = 324 bytes
        var data = new byte[324];

        // URL (256 bytes, ASCII, null-terminated)
        var urlBytes = System.Text.Encoding.ASCII.GetBytes(_propUrl.Trim());
        if (urlBytes.Length > 255) throw new InvalidOperationException("URL too long (max 255 chars).");
        Array.Copy(urlBytes, data, urlBytes.Length);

        // Epoch
        var epoch = TickMonitor.IsConnected ? TickMonitor.Epoch : (ushort)0;
        if (epoch == 0) throw new InvalidOperationException("Cannot determine current epoch. Please connect to the network.");
        BinaryPrimitives.WriteUInt16LittleEndian(data.AsSpan(256), epoch);

        // Type = Transfer: Yes/No (0x0102) — only type allowed for CCF
        BinaryPrimitives.WriteUInt16LittleEndian(data.AsSpan(258), 0x0102);

        // Tick = 0 (system fills at offset 260-263, already zero)

        // Data union: destination(32) at offset 264, amount(8) at offset 296
        var err = IdentityValidation.Validate(_propDest);
        if (err != null) throw new InvalidOperationException($"Invalid destination: {err}");
        if (!QubicIdentity.TryParse(_propDest.Trim(), out var destId))
            throw new InvalidOperationException("Could not parse destination identity.");
        destId.PublicKey.CopyTo(data.AsSpan(264));
        BinaryPrimitives.WriteInt64LittleEndian(data.AsSpan(296), _propAmount);

        // Subscription fields (at offset 304)
        data[304] = (byte)(_propIsSub ? 1 : 0);
        if (_propIsSub)
        {
            data[305] = (byte)_propWeeksPerPeriod;
            // _padding0 at 306-307 already zero
            BinaryPrimitives.WriteUInt32LittleEndian(data.AsSpan(308), _propStartEpoch);
            BinaryPrimitives.WriteUInt64LittleEndian(data.AsSpan(312), _propAmountPerPeriod);
            BinaryPrimitives.WriteUInt32LittleEndian(data.AsSpan(320), _propNumPeriods);
        }

        return data;
    }

    // ══════════════════════════════════════════════════════════
    // Vote
    // ══════════════════════════════════════════════════════════

    async Task LoadVoteProposal()
    {
        _loading = true; _error = null; _voteProposal = null;
        try
        {
            var input = new GetProposalInput { SubscriptionDestination = new byte[32], ProposalIndex = (ushort)_voteProposalIndex };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 2, input.ToBytes());
            _voteProposal = ParseCcfProposalResponse((ushort)_voteProposalIndex, result);
            if (_voteProposal == null) _error = "Proposal not found or invalid.";
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    async Task SubmitVote()
    {
        if (_voteProposal == null) { _error = "Load proposal first."; return; }
        _sending = true; _error = null; _result = null;
        try
        {
            if (!long.TryParse(_voteValue, out var voteVal)) { _error = "Invalid vote value."; _sending = false; return; }
            var data = BuildVotePayload(_voteProposal, voteVal);
            await BroadcastCcf(0, data, $"CCF Vote (index={_voteProposalIndex}, value={voteVal})");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    async Task ClearVote()
    {
        if (_voteProposal == null) { _error = "Load proposal first."; return; }
        _sending = true; _error = null; _result = null;
        try
        {
            var data = BuildVotePayload(_voteProposal, NO_VOTE_VALUE);
            await BroadcastCcf(0, data, $"CCF Clear Vote (index={_voteProposalIndex})");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    static byte[] BuildVotePayload(CcfParsedProposal proposal, long voteValue)
    {
        var data = new byte[16];
        BinaryPrimitives.WriteUInt16LittleEndian(data.AsSpan(0), proposal.Index);
        BinaryPrimitives.WriteUInt16LittleEndian(data.AsSpan(2), proposal.Type);
        BinaryPrimitives.WriteUInt32LittleEndian(data.AsSpan(4), proposal.Tick);
        BinaryPrimitives.WriteInt64LittleEndian(data.AsSpan(8), voteValue);
        return data;
    }

    // ══════════════════════════════════════════════════════════
    // Results
    // ══════════════════════════════════════════════════════════

    async Task LoadResults()
    {
        _loading = true; _error = null; _resultsData = null;
        try
        {
            var input = new GetVotingResultsInput { ProposalIndex = (ushort)_resultsIndex };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 4, input.ToBytes());

            if (result.Length < 2 || result[0] == 0) { _error = "No results found for this proposal."; return; }

            int off = result.Length >= 56 ? 8 : 1;
            var d = result.AsSpan(off);

            var optVotes = new uint[8];
            for (int i = 0; i < 8; i++)
                optVotes[i] = BinaryPrimitives.ReadUInt32LittleEndian(d[(16 + i * 4)..]);

            _resultsData = new ParsedResults(
                BinaryPrimitives.ReadUInt16LittleEndian(d),
                BinaryPrimitives.ReadUInt16LittleEndian(d[2..]),
                BinaryPrimitives.ReadUInt32LittleEndian(d[4..]),
                BinaryPrimitives.ReadUInt32LittleEndian(d[8..]),
                BinaryPrimitives.ReadUInt32LittleEndian(d[12..]),
                optVotes,
                BinaryPrimitives.ReadInt64LittleEndian(d[16..])
            );
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    // ══════════════════════════════════════════════════════════
    // Get Vote
    // ══════════════════════════════════════════════════════════

    async Task LoadVote()
    {
        _loading = true; _error = null; _getVoteData = null;
        try
        {
            byte[] voterPk;
            if (string.IsNullOrWhiteSpace(_getVoteIdentity))
            {
                if (!Seed.HasSeed) { _error = "Enter voter identity or connect your seed."; _loading = false; return; }
                voterPk = Seed.GetPublicKey();
            }
            else
            {
                var err = IdentityValidation.Validate(_getVoteIdentity);
                if (err != null) { _error = err; _loading = false; return; }
                if (!QubicIdentity.TryParse(_getVoteIdentity.Trim(), out var voterId))
                { _error = "Invalid voter identity."; _loading = false; return; }
                voterPk = voterId.PublicKey;
            }

            var input = new GetVoteInput { Voter = voterPk, ProposalIndex = (ushort)_getVoteIndex };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 3, input.ToBytes());

            if (result.Length < 2 || result[0] == 0) { _error = "No vote found."; return; }

            int off = result.Length >= 24 ? 8 : 1;
            var d = result.AsSpan(off);

            _getVoteData = new ParsedVote(
                BinaryPrimitives.ReadUInt16LittleEndian(d),
                BinaryPrimitives.ReadUInt16LittleEndian(d[2..]),
                BinaryPrimitives.ReadUInt32LittleEndian(d[4..]),
                BinaryPrimitives.ReadInt64LittleEndian(d[8..])
            );
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    // ══════════════════════════════════════════════════════════
    // Subscriptions
    // ══════════════════════════════════════════════════════════

    async Task LoadSubscription()
    {
        _loading = true; _error = null; _subResult = null;
        try
        {
            var err = IdentityValidation.Validate(_subLookupDest);
            if (err != null) { _error = err; _loading = false; return; }
            if (!QubicIdentity.TryParse(_subLookupDest.Trim(), out var destId))
            { _error = "Invalid destination identity."; _loading = false; return; }

            // Use GetProposal (function 2) with proposalIndex=0 and subscriptionDestination set
            var input = new GetProposalInput { SubscriptionDestination = destId.PublicKey, ProposalIndex = 0 };
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 2, input.ToBytes());

            if (result.Length < 8) { _subResult = new SubscriptionResult(false, "", "", 0, 0, 0, 0, 0); return; }

            bool hasActive = result[2] != 0;
            if (!hasActive || result.Length < 344 + 312)
            {
                _subResult = new SubscriptionResult(false, "", "", 0, 0, 0, 0, 0);
                return;
            }

            // Parse SubscriptionData at offset 344
            var sd = result.AsSpan(344, 312);
            var sdDest = SafeIdentityFromPk(sd[..32].ToArray());
            var sdUrl = SafeUrlFromBytes(sd.Slice(32, 256));
            _subResult = new SubscriptionResult(true, sdDest, sdUrl, sd[288],
                BinaryPrimitives.ReadUInt32LittleEndian(sd[292..]),
                BinaryPrimitives.ReadUInt64LittleEndian(sd[296..]),
                BinaryPrimitives.ReadUInt32LittleEndian(sd[304..]),
                BinaryPrimitives.ReadInt32LittleEndian(sd[308..]));
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    // ══════════════════════════════════════════════════════════
    // Transfers
    // ══════════════════════════════════════════════════════════

    async Task LoadTransfers()
    {
        _loading = true; _error = null; _transfers = null;
        try
        {
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 5, []);
            var output = GetLatestTransfersOutput.FromBytes(result);
            _transfers = output.Entries
                .Where(e => e.Destination.Any(b => b != 0))
                .Select(e => new TransferEntry(
                    SafeIdentityFromPk(e.Destination),
                    SafeUrlFromBytes(e.Url),
                    e.Amount, e.Tick, e.Success))
                .ToList();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    // ══════════════════════════════════════════════════════════
    // Payments
    // ══════════════════════════════════════════════════════════

    async Task LoadPayments()
    {
        _loading = true; _error = null; _payments = null;
        try
        {
            var result = await Backend.QuerySmartContractAsync(CcfIndex, 7, []);
            var output = GetRegularPaymentsOutput.FromBytes(result);
            _payments = output.Entries
                .Where(e => e.Destination.Any(b => b != 0))
                .Select(e => new PaymentEntry(
                    SafeIdentityFromPk(e.Destination),
                    SafeUrlFromBytes(e.Url),
                    e.Amount, e.Tick, e.PeriodIndex, e.Success))
                .ToList();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    // ══════════════════════════════════════════════════════════
    // URL confirm
    // ══════════════════════════════════════════════════════════

    async Task ConfirmOpenUrl(string url)
    {
        var confirmed = await _confirmDialog.ShowAsync(
            $"This link was provided by a CCF proposal and may be potentially dangerous.\n\n{url}");
        if (confirmed)
            await JS.InvokeVoidAsync("open", url, "_blank");
    }

    // ══════════════════════════════════════════════════════════
    // Broadcast helpers
    // ══════════════════════════════════════════════════════════

    async Task BroadcastCcf(long amount, byte[] data, string desc)
    {
        var tick = await GetTick();
        var dest = QubicIdentity.FromPublicKey(Qubic.Core.QubicContracts.GetContractPublicKey((int)CcfIndex));
        var payload = new GenericContractPayload((ushort)(desc.Contains("Vote") ? 2 : 1), data);
        var tx = Seed.CreateAndSignTransaction(dest, amount, tick, payload);
        var result = await Backend.BroadcastTransactionAsync(tx);
        _result = result.TransactionId;
        TxTracker.Track(new TrackedTransaction
        {
            Hash = result.TransactionId,
            Source = Seed.Identity?.ToString() ?? "",
            Destination = dest.ToString(),
            Amount = amount,
            TargetTick = tick,
            InputType = payload.InputType,
            PayloadHex = Convert.ToHexString(payload.GetPayloadBytes()),
            Description = desc
        });
    }
}
