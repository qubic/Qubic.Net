@page "/tx/ipobid"
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject QubicSettingsService Settings

<h4>IPO Bid</h4>
<p class="text-muted">Place a bid in a contract's Initial Public Offering.</p>

@if (!Seed.HasSeed)
{
    <div class="seed-warning">Enter your seed in the top bar to enable signing.</div>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Make IPO Bid</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label-sm">Contract</label>
                        @if (_activeIpos != null && _activeIpos.Count > 0)
                        {
                            <select class="form-select form-select-sm" @bind="_selectedContractIndex">
                                <option value="0">-- Select active IPO --</option>
                                @foreach (var ipo in _activeIpos)
                                {
                                    <option value="@ipo.ContractIndex">@ipo.ContractIndex â€” @ipo.AssetName</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="number" class="form-control form-control-sm" min="1" max="23" @bind="_selectedContractIndex" placeholder="Contract index (1-23)" />
                        }
                    </div>
                    <div class="mb-2">
                        <label class="form-label-sm">Bid Amount (QU)</label>
                        <input type="number" class="form-control form-control-sm" min="1" @bind="_bidAmount" />
                    </div>

                    @if (_selectedContractIndex > 0)
                    {
                        <div class="small text-muted mb-2">
                            Destination: <span class="mono">@GetContractIdentity()</span>
                        </div>
                    }

                    @if (!_confirmed)
                    {
                        <button class="btn btn-primary" @onclick="() => _confirmed = true"
                                disabled="@(_selectedContractIndex == 0 || _bidAmount <= 0)">
                            Preview Bid
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            You are about to bid <strong>@_bidAmount.ToString("N0")</strong> QU for contract <strong>@_selectedContractIndex</strong>.
                            The bid amount will be transferred to the contract. Bids are ranked and only the top 676 are accepted.
                        </div>
                        <button class="btn btn-primary me-2" @onclick="SubmitBid" disabled="@_sending">
                            @(_sending ? "Submitting..." : "Confirm Bid")
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="() => _confirmed = false">Cancel</button>
                    }

                    @if (_result != null)
                    {
                        <div class="alert alert-success mt-3">
                            IPO bid broadcast! Tx ID: <span class="mono">@_result</span>
                            <div class="mt-1">
                                <a href="https://explorer.qubic.org/network/tx/@_result" target="_blank" rel="noopener" class="me-3">View on Explorer</a>
                                <a href="/tx/history">Transaction History</a>
                            </div>
                        </div>
                    }
                    @if (_error != null)
                    {
                        <div class="alert alert-danger mt-2">@_error</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private IReadOnlyList<Qubic.Rpc.Models.IpoInfo>? _activeIpos;
    private uint _selectedContractIndex;
    private long _bidAmount;
    private bool _confirmed;
    private bool _sending;
    private string? _result;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _activeIpos = await Backend.GetActiveIposAsync();
        }
        catch { /* IPO list is optional, user can enter manually */ }
    }

    private string GetContractIdentity()
    {
        return Qubic.Core.QubicContracts.GetContractIdentity((int)_selectedContractIndex).ToString();
    }

    private async Task SubmitBid()
    {
        _sending = true;
        _error = null;
        _result = null;

        try
        {
            if (_selectedContractIndex == 0 || _bidAmount <= 0)
            {
                _error = "Select a contract and enter a bid amount.";
                return;
            }

            var tick = TickMonitor.IsConnected
                ? TickMonitor.Tick + (uint)Settings.TickOffset
                : (await Backend.GetTickInfoAsync()).Tick + (uint)Settings.TickOffset;

            var dest = Qubic.Core.QubicContracts.GetContractIdentity((int)_selectedContractIndex);
            var tx = Seed.CreateAndSignTransfer(dest, _bidAmount, tick);
            var result = await Backend.BroadcastTransactionAsync(tx);
            _result = result.TransactionId;
            _confirmed = false;

            TxTracker.Track(new TrackedTransaction
            {
                Hash = result.TransactionId,
                Source = Seed.Identity?.ToString() ?? "",
                Destination = dest.ToString(),
                Amount = _bidAmount,
                TargetTick = tick,
                Description = $"IPO Bid {_bidAmount:N0} QU for contract {_selectedContractIndex}"
            });
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _sending = false;
        }
    }
}
