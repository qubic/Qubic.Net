@page "/tx/quottery"
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject QubicSettingsService Settings

<h4>Quottery (Betting)</h4>
<p class="text-muted">Issue bets, join bets, publish results, or cancel bets on the Quottery contract.</p>

@if (_basicInfo != null)
{
    <div class="small text-muted mb-2">
        Fees &mdash; Per Slot/Hour: <strong>@_basicInfo.Value.feePerSlotPerHour.ToString("N0")</strong> |
        Operator: <strong>@_basicInfo.Value.operatorFee.ToString("N0")</strong> |
        Shareholder: <strong>@_basicInfo.Value.shareholderFee.ToString("N0")</strong> |
        Min Bet Slot: <strong>@_basicInfo.Value.minBetSlot.ToString("N0")</strong> |
        Burn: <strong>@_basicInfo.Value.burnFee.ToString("N0")</strong>
    </div>
}

@if (!Seed.HasSeed)
{
    <div class="seed-warning">Enter your seed in the top bar to enable signing.</div>
}
else
{
    <ul class="nav nav-tabs mb-3">
        @foreach (var tab in _tabs)
        {
            <li class="nav-item">
                <a class="nav-link @(tab == _activeTab ? "active" : "")" href="" @onclick="() => _activeTab = tab" @onclick:preventDefault>@tab</a>
            </li>
        }
    </ul>

    <div class="row"><div class="col-md-8">
        @switch (_activeTab)
        {
            case "Join Bet":
                <div class="card"><div class="card-header">Join Bet</div><div class="card-body">
                    <div class="mb-2"><label class="form-label-sm">Bet ID</label>
                        <input type="number" class="form-control form-control-sm" min="0" @bind="_joinBetId" /></div>
                    <div class="mb-2"><label class="form-label-sm">Number of Slots</label>
                        <input type="number" class="form-control form-control-sm" min="1" @bind="_joinSlots" /></div>
                    <div class="mb-2"><label class="form-label-sm">Amount per Slot (QU)</label>
                        <input type="number" class="form-control form-control-sm" min="1" @bind="_joinAmountPerSlot" /></div>
                    <div class="mb-2"><label class="form-label-sm">Picked Option</label>
                        <input type="number" class="form-control form-control-sm" min="0" @bind="_joinOption" /></div>
                    @if (_joinSlots > 0 && _joinAmountPerSlot > 0)
                    {
                        <div class="small text-muted mb-2">Total: @((_joinSlots * _joinAmountPerSlot).ToString("N0")) QU</div>
                    }
                    <button class="btn btn-primary" @onclick="JoinBet" disabled="@_sending">@(_sending ? "Joining..." : "Join Bet")</button>
                </div></div>
                break;

            case "Cancel Bet":
                <div class="card"><div class="card-header">Cancel Bet</div><div class="card-body">
                    <p class="small text-muted">Only the game operator can cancel a bet.</p>
                    <div class="mb-2"><label class="form-label-sm">Bet ID</label>
                        <input type="number" class="form-control form-control-sm" min="0" @bind="_cancelBetId" /></div>
                    <button class="btn btn-warning" @onclick="CancelBet" disabled="@_sending">@(_sending ? "Cancelling..." : "Cancel Bet")</button>
                </div></div>
                break;

            case "Publish Result":
                <div class="card"><div class="card-header">Publish Result</div><div class="card-body">
                    <p class="small text-muted">Oracle providers only: publish the winning option for a bet.</p>
                    <div class="mb-2"><label class="form-label-sm">Bet ID</label>
                        <input type="number" class="form-control form-control-sm" min="0" @bind="_pubBetId" /></div>
                    <div class="mb-2"><label class="form-label-sm">Winning Option</label>
                        <input type="number" class="form-control form-control-sm" min="0" @bind="_pubWinOption" /></div>
                    <button class="btn btn-primary" @onclick="PublishResult" disabled="@_sending">@(_sending ? "Publishing..." : "Publish Result")</button>
                </div></div>
                break;

            case "Issue Bet":
                <div class="card"><div class="card-header">Issue Bet</div><div class="card-body">
                    <p class="small text-muted">Create a new bet with up to 8 options and oracle providers.</p>
                    <div class="mb-2"><label class="form-label-sm">Bet Description (max 32 chars)</label>
                        <input class="form-control form-control-sm" maxlength="32" @bind="_issueBetDesc" /></div>
                    <div class="mb-2"><label class="form-label-sm">Number of Options (1-8)</label>
                        <input type="number" class="form-control form-control-sm" min="1" max="8" @bind="_issueNumOptions" /></div>
                    @for (int i = 0; i < Math.Min(_issueNumOptions, 8); i++)
                    {
                        var idx = i;
                        <div class="mb-1"><label class="form-label-sm">Option @(idx + 1) Description (max 32 chars)</label>
                            <input class="form-control form-control-sm" maxlength="32" @bind="_issueOptionDescs[idx]" /></div>
                    }
                    <div class="mb-2"><label class="form-label-sm">Oracle Provider Identities (one per line, up to 8)</label>
                        <textarea class="form-control form-control-sm mono" rows="3" @bind="_issueOracleText" placeholder="IDENTITY1&#10;IDENTITY2"></textarea></div>
                    <div class="mb-2"><label class="form-label-sm">Oracle Fee per Provider (comma-separated)</label>
                        <input class="form-control form-control-sm" @bind="_issueOracleFeesText" placeholder="100,100" /></div>
                    <div class="row g-2 mb-2">
                        <div class="col"><label class="form-label-sm">Close Date (epoch secs)</label>
                            <input type="number" class="form-control form-control-sm" @bind="_issueCloseDate" /></div>
                        <div class="col"><label class="form-label-sm">End Date (epoch secs)</label>
                            <input type="number" class="form-control form-control-sm" @bind="_issueEndDate" /></div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col"><label class="form-label-sm">Amount per Slot (QU)</label>
                            <input type="number" class="form-control form-control-sm" @bind="_issueAmountPerSlot" /></div>
                        <div class="col"><label class="form-label-sm">Max Slots per Option</label>
                            <input type="number" class="form-control form-control-sm" @bind="_issueMaxSlots" /></div>
                    </div>
                    <button class="btn btn-primary" @onclick="IssueBet" disabled="@_sending">@(_sending ? "Issuing..." : "Issue Bet")</button>
                </div></div>
                break;
        }

        @if (_result != null)
        {
            <div class="alert alert-success mt-3">
                Transaction broadcast! Tx ID: <span class="mono">@_result</span>
                <div class="mt-1">
                    <a href="https://explorer.qubic.org/network/tx/@_result" target="_blank" rel="noopener" class="me-3">View on Explorer</a>
                    <a href="/tx/history">Transaction History</a>
                </div>
            </div>
        }
        @if (_error != null) { <div class="alert alert-danger mt-2">@_error</div> }
    </div></div>
}

@code {
    private static readonly string[] _tabs = ["Join Bet", "Cancel Bet", "Publish Result", "Issue Bet"];
    private string _activeTab = "Join Bet";
    private bool _sending;
    private string? _result;
    private string? _error;
    private const int ContractIndex = 2;
    private (ulong feePerSlotPerHour, ulong operatorFee, ulong shareholderFee, ulong minBetSlot, ulong burnFee)? _basicInfo;

    // Join
    private uint _joinBetId; private uint _joinSlots = 1; private long _joinAmountPerSlot; private uint _joinOption;
    // Cancel
    private uint _cancelBetId;
    // Publish
    private uint _pubBetId; private uint _pubWinOption;
    // Issue
    private string _issueBetDesc = "";
    private int _issueNumOptions = 2;
    private readonly string[] _issueOptionDescs = new string[8];
    private string _issueOracleText = "";
    private string _issueOracleFeesText = "";
    private uint _issueCloseDate; private uint _issueEndDate;
    private long _issueAmountPerSlot; private uint _issueMaxSlots;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Backend.QuerySmartContractAsync(ContractIndex, 1, []);
            if (result.Length >= 40)
                _basicInfo = (BitConverter.ToUInt64(result, 0), BitConverter.ToUInt64(result, 8),
                              BitConverter.ToUInt64(result, 16), BitConverter.ToUInt64(result, 24),
                              BitConverter.ToUInt64(result, 32));
        }
        catch { }
    }

    private async Task<uint> GetTick() => TickMonitor.IsConnected
        ? TickMonitor.Tick + (uint)Settings.TickOffset
        : (await Backend.GetTickInfoAsync()).Tick + (uint)Settings.TickOffset;

    private async Task Broadcast(long amount, uint tick, Qubic.Core.Payloads.ITransactionPayload payload, string desc)
    {
        var dest = Qubic.Core.Entities.QubicIdentity.FromPublicKey(Qubic.Core.QubicContracts.GetContractPublicKey(ContractIndex));
        var tx = Seed.CreateAndSignTransaction(dest, amount, tick, payload);
        var result = await Backend.BroadcastTransactionAsync(tx);
        _result = result.TransactionId;
        TxTracker.Track(new TrackedTransaction { Hash = result.TransactionId, Source = Seed.Identity?.ToString() ?? "",
            Destination = dest.ToString(), Amount = amount, TargetTick = tick,
            InputType = payload.InputType, PayloadHex = Convert.ToHexString(payload.GetPayloadBytes()), Description = desc });
    }

    private async Task JoinBet()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (_joinSlots <= 0) { _error = "Slots must be positive."; return; }
            if (_joinAmountPerSlot <= 0) { _error = "Amount per slot must be positive."; return; }
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Quottery.JoinBetPayload
            {
                BetId = _joinBetId, NumberOfSlot = _joinSlots, Option = _joinOption
            };
            var total = (long)_joinSlots * _joinAmountPerSlot;
            await Broadcast(total, tick, payload, $"Quottery Join Bet {_joinBetId}: {_joinSlots} slots @ {_joinAmountPerSlot:N0} QU, option {_joinOption}");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task CancelBet()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Quottery.CancelBetPayload { BetId = _cancelBetId };
            await Broadcast(0, tick, payload, $"Quottery Cancel Bet {_cancelBetId}");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task PublishResult()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Quottery.PublishResultPayload { BetId = _pubBetId, Option = _pubWinOption };
            await Broadcast(0, tick, payload, $"Quottery Publish Result: Bet {_pubBetId}, winner option {_pubWinOption}");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task IssueBet()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_issueBetDesc)) { _error = "Description required."; return; }
            if (_issueNumOptions < 1 || _issueNumOptions > 8) { _error = "Options must be 1-8."; return; }

            var betDesc = new byte[32];
            System.Text.Encoding.UTF8.GetBytes(_issueBetDesc.Trim()).AsSpan(0, Math.Min(_issueBetDesc.Trim().Length, 32)).CopyTo(betDesc);

            var optionDescs = new byte[8][];
            for (int i = 0; i < 8; i++)
            {
                optionDescs[i] = new byte[32];
                if (i < _issueNumOptions && !string.IsNullOrWhiteSpace(_issueOptionDescs[i]))
                {
                    var b = System.Text.Encoding.UTF8.GetBytes(_issueOptionDescs[i].Trim());
                    Array.Copy(b, optionDescs[i], Math.Min(b.Length, 32));
                }
            }

            var oracleIds = new byte[8][];
            var oracleLines = _issueOracleText.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            for (int i = 0; i < 8; i++)
            {
                if (i < oracleLines.Length)
                {
                    var err = IdentityValidation.Validate(oracleLines[i]);
                    if (err != null) { _error = $"Oracle {i + 1}: {err}"; return; }
                    oracleIds[i] = Qubic.Core.Entities.QubicIdentity.FromIdentity(oracleLines[i].Trim()).PublicKey;
                }
                else oracleIds[i] = new byte[32];
            }

            var oracleFees = new uint[8];
            if (!string.IsNullOrWhiteSpace(_issueOracleFeesText))
            {
                var parts = _issueOracleFeesText.Split(',', StringSplitOptions.TrimEntries);
                for (int i = 0; i < Math.Min(parts.Length, 8); i++)
                    if (uint.TryParse(parts[i], out var fee)) oracleFees[i] = fee;
            }

            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Quottery.IssueBetPayload
            {
                BetDesc = betDesc, OptionDesc = optionDescs, OracleProviderId = oracleIds,
                OracleFees = oracleFees, CloseDate = _issueCloseDate, EndDate = _issueEndDate,
                AmountPerSlot = (ulong)_issueAmountPerSlot, MaxBetSlotPerOption = _issueMaxSlots,
                NumberOfOption = (uint)_issueNumOptions
            };
            await Broadcast(0, tick, payload, $"Quottery Issue Bet: {_issueBetDesc.Trim()} ({_issueNumOptions} options)");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }
}
