@page "/tx/lookup"
@inject QubicBackendService Backend

<h4>Transaction Lookup</h4>
<p class="text-muted">Look up a transaction by its ID.</p>

<div class="row">
    <div class="col-md-10">
        <div class="input-group mb-3">
            <input class="form-control" placeholder="Enter 60-character Tx ID" @bind="_hash" />
            <button class="btn btn-primary" @onclick="Lookup" disabled="@_loading">
                @(_loading ? "Looking up..." : "Lookup")
            </button>
        </div>

        @if (_txInfo != null)
        {
            <div class="card mb-3">
                <div class="card-header">Transaction (RPC)</div>
                <div class="card-body">
                    <table class="table table-sm output-table mb-0">
                        <tr>
                            <td>Tx ID</td>
                            <td class="mono">
                                @_txInfo.Hash
                                <a href="https://explorer.qubic.org/network/tx/@_txInfo.Hash" target="_blank" rel="noopener" class="ms-2 small">Explorer</a>
                            </td>
                        </tr>
                        <tr><td>Source</td><td class="mono">@_txInfo.Source</td></tr>
                        <tr><td>Destination</td><td class="mono">@_txInfo.Destination</td></tr>
                        <tr><td>Amount</td><td class="mono">@_txInfo.Amount QU</td></tr>
                        <tr><td>Tick</td><td class="mono">@_txInfo.TickNumber</td></tr>
                        <tr><td>Input Type</td><td class="mono">@_txInfo.InputType</td></tr>
                        <tr><td>Input Size</td><td class="mono">@_txInfo.InputSize</td></tr>
                        @if (_txInfo.MoneyFlew.HasValue)
                        {
                            <tr><td>Money Flew</td><td class="mono">@_txInfo.MoneyFlew.Value</td></tr>
                        }
                    </table>
                </div>
            </div>
        }

        @if (_receipt != null)
        {
            <div class="card mb-3">
                <div class="card-header">Receipt (Bob)</div>
                <div class="card-body">
                    <table class="table table-sm output-table mb-0">
                        <tr><td>Status</td><td class="mono">@_receipt.Status</td></tr>
                        @if (_receipt.Tick > 0)
                        {
                            <tr><td>Tick</td><td class="mono">@_receipt.Tick</td></tr>
                        }
                    </table>
                </div>
            </div>
        }

        @if (_error != null)
        {
            <div class="alert alert-danger">@_error</div>
        }
        @if (!_loading && _txInfo == null && _receipt == null && _searched)
        {
            <div class="alert alert-warning">Transaction not found.</div>
        }
    </div>
</div>

@code {
    private string? _hash;
    private Qubic.Rpc.Models.TransactionInfo? _txInfo;
    private Qubic.Bob.Models.TransactionReceiptResponse? _receipt;
    private bool _loading;
    private string? _error;
    private bool _searched;

    private async Task Lookup()
    {
        if (string.IsNullOrWhiteSpace(_hash)) return;

        _loading = true;
        _error = null;
        _txInfo = null;
        _receipt = null;
        _searched = true;

        try
        {
            // Try RPC lookup
            try { _txInfo = await Backend.GetTransactionByHashAsync(_hash.Trim()); }
            catch { /* RPC might fail */ }

            // Try Bob receipt
            try { _receipt = await Backend.GetTransactionReceiptAsync(_hash.Trim()); }
            catch { /* Bob might fail */ }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
