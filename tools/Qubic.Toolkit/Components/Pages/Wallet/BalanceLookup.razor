@page "/wallet/balance"
@inject QubicBackendService Backend

<h4>Balance Lookup</h4>
<p class="text-muted">Query the balance for any Qubic identity.</p>

<div class="row">
    <div class="col-md-8">
        <div class="input-group mb-1">
            <input class="form-control @IdentityValidation.CssClass(_identity)"
                   placeholder="Enter 60-character identity (e.g. BAAAAA...)" @bind="_identity" @bind:event="oninput" />
            <button class="btn btn-primary" @onclick="Lookup" disabled="@(_loading || IdentityValidation.Validate(_identity) != null)">
                @(_loading ? "Querying..." : "Lookup")
            </button>
        </div>
        @{ var idErr = IdentityValidation.Validate(_identity); }
        @if (idErr != null)
        {
            <div class="small text-danger mb-2">@idErr</div>
        }
        else
        {
            <div class="mb-2"></div>
        }

        @if (_balance != null)
        {
            <div class="card">
                <div class="card-header">Balance</div>
                <div class="card-body">
                    <table class="table table-sm output-table mb-0">
                        <tr><td>Identity</td><td>string</td><td class="mono">@_balance.Identity</td></tr>
                        <tr><td>Balance</td><td>long</td><td class="mono"><strong>@_balance.Amount.ToString("N0")</strong> QU</td></tr>
                        <tr><td>Incoming Transfers</td><td>uint</td><td class="mono">@_balance.IncomingCount</td></tr>
                        <tr><td>Outgoing Transfers</td><td>uint</td><td class="mono">@_balance.OutgoingCount</td></tr>
                        @if (_balance.AtTick.HasValue)
                        {
                            <tr><td>Valid At Tick</td><td>uint</td><td class="mono">@_balance.AtTick</td></tr>
                        }
                    </table>
                </div>
            </div>
        }

        @if (_error != null)
        {
            <div class="alert alert-danger mt-2">@_error</div>
        }
    </div>
</div>

@code {
    private string? _identity;
    private Qubic.Core.Entities.QubicBalance? _balance;
    private bool _loading;
    private string? _error;

    private async Task Lookup()
    {
        if (IdentityValidation.Validate(_identity) != null) return;

        _loading = true;
        _error = null;
        _balance = null;

        try
        {
            var id = Qubic.Core.Entities.QubicIdentity.FromIdentity(_identity!.Trim());
            _balance = await Backend.GetBalanceAsync(id);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
