@page "/wallet/assets"
@inject QubicBackendService Backend

<h4>Asset Portfolio</h4>
<p class="text-muted">View owned, issued, and possessed assets for any identity. (RPC only)</p>

<div class="row mb-3">
    <div class="col-md-10">
        <div class="input-group mb-1">
            <input class="form-control @IdentityValidation.CssClass(_identity)"
                   placeholder="Enter 60-character identity" @bind="_identity" @bind:event="oninput" />
            <button class="btn btn-primary" @onclick="Lookup" disabled="@(_loading || IdentityValidation.Validate(_identity) != null)">
                @(_loading ? "Loading..." : "Lookup Assets")
            </button>
        </div>
        @{ var idErr = IdentityValidation.Validate(_identity); }
        @if (idErr != null)
        {
            <div class="small text-danger">@idErr</div>
        }
    </div>
</div>

@if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}

@if (_owned != null)
{
    <div class="card mb-3">
        <div class="card-header">Owned Assets (@_owned.Count)</div>
        <div class="card-body">
            @if (_owned.Count == 0)
            {
                <span class="text-muted">No owned assets.</span>
            }
            else
            {
                <DataTable Items="_owned">
                    <DataColumn TItem="Qubic.Rpc.Models.OwnedAssetInfo" Title="Asset" Field="@(a => a.Data.IssuedAsset?.Name ?? "?")" Filterable="true" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.OwnedAssetInfo" Title="Units" Field="@(a => a.Data.NumberOfUnits)" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.OwnedAssetInfo" Title="Contract" Field="@(a => Qubic.Core.QubicContracts.FormatContract((int)a.Data.ManagingContractIndex))" />
                    <DataColumn TItem="Qubic.Rpc.Models.OwnedAssetInfo" Title="Issuance" Field="@(a => a.Data.IssuanceIndex)" />
                </DataTable>
            }
        </div>
    </div>
}

@if (_possessed != null)
{
    <div class="card mb-3">
        <div class="card-header">Possessed Assets (@_possessed.Count)</div>
        <div class="card-body">
            @if (_possessed.Count == 0)
            {
                <span class="text-muted">No possessed assets.</span>
            }
            else
            {
                <DataTable Items="_possessed">
                    <DataColumn TItem="Qubic.Rpc.Models.PossessedAssetInfo" Title="Asset" Field="@(a => a.Data.OwnedAsset?.IssuedAsset?.Name ?? "?")" Filterable="true" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.PossessedAssetInfo" Title="Units" Field="@(a => a.Data.NumberOfUnits)" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.PossessedAssetInfo" Title="Possessor" Field="@(a => a.Data.PossessorIdentity)">
                        <AddressDisplay Address="@context.Data.PossessorIdentity" />
                    </DataColumn>
                    <DataColumn TItem="Qubic.Rpc.Models.PossessedAssetInfo" Title="Contract" Field="@(a => Qubic.Core.QubicContracts.FormatContract((int)a.Data.ManagingContractIndex))" />
                </DataTable>
            }
        </div>
    </div>
}

@if (_issued != null)
{
    <div class="card mb-3">
        <div class="card-header">Issued Assets (@_issued.Count)</div>
        <div class="card-body">
            @if (_issued.Count == 0)
            {
                <span class="text-muted">No issued assets.</span>
            }
            else
            {
                <DataTable Items="_issued">
                    <DataColumn TItem="Qubic.Rpc.Models.IssuedAssetInfo" Title="Name" Field="@(a => a.Data.Name)" Filterable="true" Class="mono" />
                    <DataColumn TItem="Qubic.Rpc.Models.IssuedAssetInfo" Title="Issuer" Field="@(a => a.Data.IssuerIdentity)">
                        <AddressDisplay Address="@context.Data.IssuerIdentity" />
                    </DataColumn>
                    <DataColumn TItem="Qubic.Rpc.Models.IssuedAssetInfo" Title="Type" Field="@(a => a.Data.Type)" />
                    <DataColumn TItem="Qubic.Rpc.Models.IssuedAssetInfo" Title="Decimals" Field="@(a => a.Data.NumberOfDecimalPlaces)" />
                </DataTable>
            }
        </div>
    </div>
}

@code {
    private string? _identity;
    private IReadOnlyList<Qubic.Rpc.Models.OwnedAssetInfo>? _owned;
    private IReadOnlyList<Qubic.Rpc.Models.PossessedAssetInfo>? _possessed;
    private IReadOnlyList<Qubic.Rpc.Models.IssuedAssetInfo>? _issued;
    private bool _loading;
    private string? _error;

    private async Task Lookup()
    {
        if (IdentityValidation.Validate(_identity) != null) return;

        _loading = true;
        _error = null;
        _owned = null;
        _possessed = null;
        _issued = null;

        try
        {
            var id = Qubic.Core.Entities.QubicIdentity.FromIdentity(_identity!.Trim());
            var ownedTask = Backend.GetOwnedAssetsAsync(id);
            var possessedTask = Backend.GetPossessedAssetsAsync(id);
            var issuedTask = Backend.GetIssuedAssetsAsync(id);

            await Task.WhenAll(ownedTask, possessedTask, issuedTask);

            _owned = ownedTask.Result;
            _possessed = possessedTask.Result;
            _issued = issuedTask.Result;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
