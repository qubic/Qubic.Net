@page "/history"
@implements IDisposable
@inject TransactionTrackerService TxTracker
@inject TickMonitorService TickMonitor
@inject SeedSessionService Seed
@inject IJSRuntime JS

<h4>Transaction History</h4>
<p class="text-muted">Track broadcast transactions and their confirmation status. Data is encrypted and stored locally per seed.</p>

@if (TxTracker.CurrentStoragePath != null)
{
    <div class="small text-muted mb-2">
        Storage: <code>@TxTracker.CurrentStoragePath</code>
    </div>
}

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-sm btn-outline-secondary" @onclick="ExportToFile" disabled="@(TxTracker.Transactions.Count == 0)">
        Export JSON
    </button>
    <button class="btn btn-sm btn-outline-secondary" @onclick="() => _showImport = !_showImport">
        @(_showImport ? "Hide Import" : "Import JSON")
    </button>
    @if (TxTracker.Transactions.Count > 0)
    {
        <button class="btn btn-sm btn-outline-danger ms-auto" @onclick="ClearAll">Clear All</button>
    }
</div>

@if (_exportMessage != null)
{
    <div class="alert alert-success alert-dismissible py-1 small">
        @_exportMessage
        <button type="button" class="btn-close btn-close-sm" @onclick="() => _exportMessage = null"></button>
    </div>
}

@if (_showImport)
{
    <div class="card mb-3 bg-light">
        <div class="card-body py-2">
            <label class="form-label-sm">Paste exported JSON or load from file:</label>
            <div class="d-flex gap-2 mb-2">
                <input type="file" id="importFileInput" accept=".json" style="display:none" />
                <button class="btn btn-sm btn-outline-primary" @onclick="LoadFromFile">Load File</button>
            </div>
            <textarea class="form-control form-control-sm mono" rows="6"
                      placeholder="Paste JSON here..." @bind="_importText"></textarea>
            <div class="mt-2 d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-primary" @onclick="ImportFromText">Import</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => { _showImport = false; _importText = null; _importError = null; }">Cancel</button>
                @if (_importError != null)
                {
                    <span class="text-danger small">@_importError</span>
                }
                @if (_importSuccess != null)
                {
                    <span class="text-success small">@_importSuccess</span>
                }
            </div>
        </div>
    </div>
}

@if (TxTracker.Transactions.Count == 0)
{
    <div class="alert alert-info">No transactions tracked yet. Transactions will appear here after you broadcast them.</div>
}
else
{
    <div class="mb-2 small text-muted">@TxTracker.Transactions.Count transaction(s)</div>

    <div class="table-responsive">
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Tx ID</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Target Tick</th>
                    <th>Created</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var tx in TxTracker.Transactions)
                {
                    <tr>
                        <td>
                            @switch (tx.Status)
                            {
                                case TrackedTxStatus.Pending:
                                    if (TickMonitor.IsConnected && tx.TargetTick > TickMonitor.Tick)
                                    {
                                        <span class="badge bg-warning text-dark" title="Waiting for tick @tx.TargetTick (current: @TickMonitor.Tick)">
                                            Pending (@(tx.TargetTick - TickMonitor.Tick) ticks)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    }
                                    break;
                                case TrackedTxStatus.Confirmed:
                                    <span class="badge bg-success">Confirmed</span>
                                    break;
                                case TrackedTxStatus.Failed:
                                    <span class="badge bg-danger">Failed</span>
                                    break;
                                case TrackedTxStatus.Unknown:
                                    <span class="badge bg-secondary">Unknown</span>
                                    break;
                            }
                        </td>
                        <td class="mono small" style="max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                            title="@tx.Hash">
                            <a href="https://explorer.qubic.org/network/tx/@tx.Hash" target="_blank" rel="noopener">@tx.Hash</a>
                        </td>
                        <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                            title="@tx.Description">@tx.Description</td>
                        <td class="mono">@tx.Amount.ToString("N0")</td>
                        <td class="mono">@tx.TargetTick.ToString("N0")</td>
                        <td class="small">@tx.CreatedUtc.ToLocalTime().ToString("HH:mm:ss")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleDetails(tx.Hash)">
                                @(_expandedHash == tx.Hash ? "Hide" : "Details")
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => TxTracker.Remove(tx.Hash)">x</button>
                        </td>
                    </tr>
                    @if (_expandedHash == tx.Hash)
                    {
                        <tr>
                            <td colspan="7">
                                <div class="bg-light rounded p-3">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr>
                                            <td class="text-muted" style="width:120px">Tx ID</td>
                                            <td class="mono">
                                                @tx.Hash
                                                <a href="https://explorer.qubic.org/network/tx/@tx.Hash" target="_blank" rel="noopener" class="ms-2 small">Explorer</a>
                                            </td>
                                        </tr>
                                        <tr><td class="text-muted">Source</td><td class="mono">@tx.Source</td></tr>
                                        <tr><td class="text-muted">Destination</td><td class="mono">@tx.Destination</td></tr>
                                        <tr><td class="text-muted">Amount</td><td>@tx.Amount.ToString("N0") QU</td></tr>
                                        <tr><td class="text-muted">Target Tick</td><td>@tx.TargetTick.ToString("N0")</td></tr>
                                        <tr><td class="text-muted">Description</td><td>@tx.Description</td></tr>
                                        <tr><td class="text-muted">Status</td><td>@tx.Status</td></tr>
                                        @if (tx.MoneyFlew != null)
                                        {
                                            <tr><td class="text-muted">Money Flew</td><td>@tx.MoneyFlew</td></tr>
                                        }
                                        <tr><td class="text-muted">Created</td><td>@tx.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td></tr>
                                        @if (tx.ResolvedUtc != null)
                                        {
                                            <tr><td class="text-muted">Resolved</td><td>@tx.ResolvedUtc.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td></tr>
                                        }
                                    </table>
                                    @if (Seed.HasSeed)
                                    {
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-primary" disabled="@(_repeating == tx.Hash)"
                                                    @onclick="() => RepeatTransaction(tx)">
                                                @(_repeating == tx.Hash ? "Repeating..." : "Repeat Transaction")
                                            </button>
                                            @if (_repeatResult == tx.Hash)
                                            {
                                                <span class="text-success small ms-2">New tx broadcast! <a href="https://explorer.qubic.org/network/tx/@_repeatNewHash" target="_blank" rel="noopener">@_repeatNewHash?[..20]...</a></span>
                                            }
                                            @if (_repeatError != null && _repeating != tx.Hash && _repeatErrorHash == tx.Hash)
                                            {
                                                <span class="text-danger small ms-2">@_repeatError</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

@code {
    private string? _expandedHash;
    private bool _showImport;
    private string? _importText;
    private string? _importError;
    private string? _importSuccess;
    private string? _exportMessage;
    private string? _repeating;
    private string? _repeatResult;
    private string? _repeatNewHash;
    private string? _repeatError;
    private string? _repeatErrorHash;
    private bool _disposed;

    protected override void OnInitialized()
    {
        TxTracker.OnChanged += OnTrackerChanged;
        TickMonitor.OnTickChanged += OnTickChanged;
    }

    private void OnTrackerChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void ToggleDetails(string hash)
    {
        _expandedHash = _expandedHash == hash ? null : hash;
    }

    private async Task ExportToFile()
    {
        try
        {
            var json = TxTracker.ExportJson();
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var base64 = Convert.ToBase64String(bytes);
            var filename = $"qubic-tx-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            await JS.InvokeVoidAsync("downloadFile", filename, "application/json", base64);
            _exportMessage = $"Exported {TxTracker.Transactions.Count} transaction(s) to {filename}";
        }
        catch (Exception ex)
        {
            _exportMessage = "Export failed: " + ex.Message;
        }
    }

    private async Task LoadFromFile()
    {
        _importError = null;
        _importSuccess = null;
        try
        {
            var content = await JS.InvokeAsync<string?>("readFileAsText", "importFileInput");
            if (content != null)
            {
                _importText = content;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _importError = "Could not read file: " + ex.Message;
        }
    }

    private void ImportFromText()
    {
        _importError = null;
        _importSuccess = null;

        if (string.IsNullOrWhiteSpace(_importText))
        {
            _importError = "Nothing to import.";
            return;
        }

        try
        {
            var count = TxTracker.ImportJson(_importText.Trim());
            if (count == 0)
                _importSuccess = "No new transactions to import (all duplicates).";
            else
                _importSuccess = $"Imported {count} transaction(s).";
            _importText = null;
        }
        catch (Exception ex)
        {
            _importError = "Invalid JSON: " + ex.Message;
        }
    }

    private async Task RepeatTransaction(TrackedTransaction tx)
    {
        _repeating = tx.Hash;
        _repeatResult = null;
        _repeatNewHash = null;
        _repeatError = null;
        _repeatErrorHash = null;

        try
        {
            var newHash = await TxTracker.RepeatAsync(tx);
            _repeatResult = tx.Hash;
            _repeatNewHash = newHash;
        }
        catch (Exception ex)
        {
            _repeatError = ex.Message;
            _repeatErrorHash = tx.Hash;
        }
        finally
        {
            _repeating = null;
        }
    }

    private void ClearAll()
    {
        TxTracker.Clear();
        _expandedHash = null;
    }

    public void Dispose()
    {
        _disposed = true;
        TxTracker.OnChanged -= OnTrackerChanged;
        TickMonitor.OnTickChanged -= OnTickChanged;
    }
}
