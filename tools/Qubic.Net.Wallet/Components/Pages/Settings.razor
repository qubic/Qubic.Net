@page "/settings"
@inject QubicSettingsService Cfg
@inject QubicBackendService Backend
@inject LabelService Labels
@inject IJSRuntime JS

<h4>Settings</h4>
<p class="text-muted">Configure Qubic.Net Wallet behavior.</p>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">Appearance</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Theme</label>
                    <select class="form-select" value="@_theme" @onchange="OnThemeChanged">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Connection Settings</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Default Backend</label>
                    <select class="form-select" value="@Backend.ActiveBackend" @onchange="OnBackendChanged">
                        <option value="@QueryBackend.Rpc">RPC</option>
                        <option value="@QueryBackend.Bob">Bob (JSON-RPC)</option>
                        <option value="@QueryBackend.DirectNetwork">Direct Network</option>
                    </select>
                    <div class="form-text">
                        RPC supports most features. Bob provides transfer history.
                        Direct Network connects to a node directly.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">RPC Connection</label>
                    <div class="input-group">
                        <select class="form-select" style="max-width:100px"
                                value="@Backend.RpcScheme" @onchange="OnRpcSchemeChanged">
                            <option value="https">https</option>
                            <option value="http">http</option>
                        </select>
                        <input type="text" class="form-control" placeholder="Host"
                               value="@Backend.RpcHost" @onchange="OnRpcHostChanged" />
                        <input type="number" class="form-control" style="max-width:100px"
                               placeholder="Port" min="1" max="65535"
                               value="@Backend.RpcPort" @onchange="OnRpcPortChanged" />
                    </div>
                    <div class="form-text">Current URL: <code>@Backend.RpcUrl</code></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Bob Connection</label>
                    <div class="input-group">
                        <select class="form-select" style="max-width:100px"
                                value="@Backend.BobScheme" @onchange="OnBobSchemeChanged">
                            <option value="https">https</option>
                            <option value="http">http</option>
                        </select>
                        <input type="text" class="form-control" placeholder="Host"
                               value="@Backend.BobHost" @onchange="OnBobHostChanged" />
                        <input type="number" class="form-control" style="max-width:100px"
                               placeholder="Port" min="1" max="65535"
                               value="@Backend.BobPort" @onchange="OnBobPortChanged" />
                    </div>
                    <div class="form-text">Current URL: <code>@Backend.BobUrl</code></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Node Connection</label>
                    <div class="input-group">
                        <span class="input-group-text" style="min-width:100px;justify-content:center">TCP</span>
                        <input type="text" class="form-control" placeholder="Host"
                               value="@Backend.NodeHost" @onchange="OnNodeHostChanged" />
                        <input type="number" class="form-control" style="max-width:100px"
                               placeholder="Port" min="1" max="65535"
                               value="@Backend.NodePort" @onchange="OnNodePortChanged" />
                    </div>
                    <div class="form-text">Current: <code>tcp://@(Backend.NodeHost):@(Backend.NodePort)</code></div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Transaction Settings</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Auto-Tick Offset</label>
                    <input type="number" class="form-control" min="1" max="100"
                           value="@Cfg.TickOffset"
                           @onchange="e => Cfg.TickOffset = int.TryParse(e.Value?.ToString(), out var v) ? v : 5" />
                    <div class="form-text">
                        Number of ticks added to the current tick when using auto-tick.
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoResend"
                               checked="@Cfg.AutoResend"
                               @onchange="e => Cfg.AutoResend = (bool)(e.Value ?? false)" />
                        <label class="form-check-label" for="autoResend">
                            Auto-Resend Failed Transactions
                        </label>
                    </div>
                    <div class="form-text">
                        Automatically re-sign and rebroadcast transactions whose target tick has passed.
                    </div>
                </div>

                @if (Cfg.AutoResend)
                {
                    <div class="mb-3">
                        <label class="form-label">Max Resend Attempts</label>
                        <input type="number" class="form-control" min="1" max="20"
                               value="@Cfg.AutoResendMaxRetries"
                               @onchange="e => Cfg.AutoResendMaxRetries = int.TryParse(e.Value?.ToString(), out var v) ? v : 3" />
                    </div>
                }
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Address Labels</div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="remoteLabels"
                               checked="@Cfg.RemoteLabelsEnabled"
                               @onchange="OnRemoteLabelsToggled" />
                        <label class="form-check-label" for="remoteLabels">
                            Load labels from remote registry
                        </label>
                    </div>
                    <div class="form-text">
                        Fetches known address labels from <code>static.qubic.org</code> on startup.
                    </div>
                </div>

                @if (Cfg.RemoteLabelsEnabled)
                {
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <button class="btn btn-outline-primary btn-sm" @onclick="RefreshLabels" disabled="@Labels.IsLoading">
                            <i class="bi bi-arrow-clockwise me-1"></i>@(Labels.IsLoading ? "Loading..." : "Refresh Labels")
                        </button>
                        @if (Labels.LastFetched != null)
                        {
                            <span class="text-muted small">
                                @Labels.RemoteLabelCount labels at @Labels.LastFetched.Value.ToString("HH:mm:ss")
                            </span>
                        }
                    </div>

                    @if (Labels.LastError != null)
                    {
                        <div class="alert alert-danger small py-1 mb-0">@Labels.LastError</div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string _theme = "light";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var saved = Cfg.GetCustom<string>("theme");
            if (!string.IsNullOrEmpty(saved))
                _theme = saved;
            else
            {
                try { _theme = await JS.InvokeAsync<string>("getTheme") ?? "light"; }
                catch { _theme = "light"; }
            }
            StateHasChanged();
        }
    }

    private async Task OnThemeChanged(ChangeEventArgs e)
    {
        _theme = e.Value?.ToString() ?? "light";
        Cfg.SetCustom("theme", _theme);
        await JS.InvokeVoidAsync("setTheme", _theme);
    }

    private void OnBackendChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<QueryBackend>(e.Value?.ToString(), out var b))
        {
            Backend.ActiveBackend = b;
            Backend.ApplySettings();
        }
    }

    private void OnRpcSchemeChanged(ChangeEventArgs e) { Backend.RpcScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnRpcHostChanged(ChangeEventArgs e) { Backend.RpcHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnRpcPortChanged(ChangeEventArgs e) { Backend.RpcPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnBobSchemeChanged(ChangeEventArgs e) { Backend.BobScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnBobHostChanged(ChangeEventArgs e) { Backend.BobHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnBobPortChanged(ChangeEventArgs e) { Backend.BobPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnNodeHostChanged(ChangeEventArgs e) { Backend.NodeHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnNodePortChanged(ChangeEventArgs e) { Backend.NodePort = int.TryParse(e.Value?.ToString(), out var v) ? v : 21841; Backend.ApplySettings(); }

    private async Task OnRemoteLabelsToggled(ChangeEventArgs e)
    {
        Cfg.RemoteLabelsEnabled = (bool)(e.Value ?? false);
        if (Cfg.RemoteLabelsEnabled)
            await RefreshLabels();
        else
            Labels.ClearRemoteLabels();
    }

    private async Task RefreshLabels()
    {
        await Labels.LoadRemoteLabelsAsync();
        StateHasChanged();
    }
}
