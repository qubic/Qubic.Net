@inherits LayoutComponentBase
@implements IDisposable
@inject QubicBackendService Backend
@inject QubicSettingsService Settings
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject IJSRuntime JS

<div class="d-flex flex-column vh-100">
    <nav class="navbar navbar-dark bg-dark px-3">
        <div class="d-flex align-items-center">
            <img src="qubic-logo.svg" height="24" class="me-2" alt="Qubic" />
            <a class="navbar-brand mb-0 h1" href="/">Qubic.Net Wallet</a>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="theme-toggle" @onclick="ToggleTheme" title="Toggle dark/light mode">
                <i class="bi @(_isDark ? "bi-sun" : "bi-moon-stars")"></i>
            </button>
            <span class="text-secondary mx-1">|</span>
            @if (Seed.HasSeed)
            {
                <span class="badge bg-danger">Seed active</span>
                <span class="badge bg-secondary mono small">@Seed.Identity?.ToString()[..12]...</span>
                <button class="btn btn-sm btn-outline-light" @onclick="ClearSeed">Clear</button>
            }
            else
            {
                <input type="password" class="form-control form-control-sm bg-dark text-light border-secondary"
                       style="width:280px" placeholder="Enter 55-char seed to enable signing..."
                       @bind="_seedInput" @bind:event="oninput" />
                <button class="btn btn-sm btn-outline-success" @onclick="SetSeed"
                        disabled="@(_seedInput?.Length != 55)">Unlock</button>
            }
            <span class="text-secondary mx-1">|</span>
            <select class="form-select form-select-sm bg-dark text-light border-secondary" style="width:auto"
                    @bind="Backend.ActiveBackend" @bind:after="OnBackendChanged">
                <option value="@QueryBackend.Rpc">RPC</option>
                <option value="@QueryBackend.Bob">Bob</option>
                <option value="@QueryBackend.DirectNetwork">Direct</option>
            </select>
            @if (Backend.ActiveBackend == QueryBackend.DirectNetwork)
            {
                <input class="form-control form-control-sm bg-dark text-light border-secondary" style="width:130px"
                       placeholder="Host" @bind="Backend.NodeHost" @bind:event="oninput" />
                <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" style="width:70px"
                       placeholder="Port" @bind="Backend.NodePort" />
            }
            else
            {
                <input class="form-control form-control-sm bg-dark text-light border-secondary" style="width:130px"
                       placeholder="Host" @bind="CurrentHost" @bind:event="oninput" />
            }
            @if (TickMonitor.IsConnected)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="Disconnect">
                    <i class="bi bi-power"></i>
                </button>
                <span class="badge bg-success mono">E@(TickMonitor.Epoch) | T@(TickMonitor.Tick)</span>
            }
            else
            {
                <button class="btn btn-sm btn-outline-info" @onclick="Reconnect" disabled="@_reconnecting">
                    @(_reconnecting ? "..." : "Connect")
                </button>
                @if (TickMonitor.Error != null)
                {
                    <span class="badge bg-danger" title="@TickMonitor.Error">Offline</span>
                }
            }
        </div>
    </nav>
    @if (Seed.HasSeed)
    {
        <div class="seed-warning text-center small py-1">
            Your seed is held in memory for this session. Clear it when done.
        </div>
    }
    <div class="d-flex flex-grow-1 overflow-hidden">
        <NavMenu />
        <main class="flex-grow-1 overflow-auto p-4">
            @Body
        </main>
    </div>
</div>

@code {
    private string? _seedInput;
    private bool _reconnecting;
    private bool _isDark;
    private bool _disposed;

    private string CurrentHost
    {
        get => Backend.ActiveBackend == QueryBackend.Rpc ? Backend.RpcHost : Backend.BobHost;
        set { if (Backend.ActiveBackend == QueryBackend.Rpc) Backend.RpcHost = value; else Backend.BobHost = value; }
    }

    protected override async Task OnInitializedAsync()
    {
        TickMonitor.OnTickChanged += OnTickChanged;

        // Load saved theme
        var savedTheme = Settings.GetCustom<string>("theme");
        _isDark = savedTheme == "dark";

        await TickMonitor.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isDark)
        {
            await JS.InvokeVoidAsync("setTheme", "dark");
        }
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void SetSeed()
    {
        if (_seedInput?.Length == 55)
        {
            try
            {
                Seed.SetSeed(_seedInput);
                TxTracker.SetEncryptionKey(_seedInput);
                _seedInput = null;
            }
            catch { }
        }
    }

    private void ClearSeed()
    {
        Seed.ClearSeed();
        TxTracker.ClearEncryptionKey();
        _seedInput = null;
    }

    private async Task OnBackendChanged()
    {
        Backend.ResetClients();
        await TickMonitor.StartAsync();
    }

    private async Task Reconnect()
    {
        _reconnecting = true;
        StateHasChanged();
        Backend.ResetClients();
        await TickMonitor.StartAsync();
        _reconnecting = false;
    }

    private async Task Disconnect()
    {
        await TickMonitor.StopAsync();
        Backend.ResetClients();
    }

    private async Task ToggleTheme()
    {
        _isDark = !_isDark;
        var theme = _isDark ? "dark" : "light";
        Settings.SetCustom("theme", theme);
        await JS.InvokeVoidAsync("setTheme", theme);
    }

    public void Dispose()
    {
        _disposed = true;
        TickMonitor.OnTickChanged -= OnTickChanged;
    }
}
